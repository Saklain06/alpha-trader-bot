#!/usr/bin/env python3
import base64
import os

B64_DATA = "IyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBCSU5BTkNFIE1VTFRJLVNUUkFURUdZIFRSQURJTkcgQk9UIChQUk9EVUNUSU9OIFYyKQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIFN0YW5kYXJkIEltcG9ydHMKaW1wb3J0IG9zCmltcG9ydCBtYXRoCmltcG9ydCB1dWlkCmltcG9ydCBhc3luY2lvCmltcG9ydCBsb2dnaW5nCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lLCB0aW1lem9uZSwgZGF0ZQoKCiMgVGhpcmQtUGFydHkgSW1wb3J0cwppbXBvcnQgcGFuZGFzIGFzIHBkCiMgaW1wb3J0IG51bXB5IGFzIG5wICMgVW51c2VkCmZyb20gZG90ZW52IGltcG9ydCBsb2FkX2RvdGVudgppbXBvcnQgY2N4dC5hc3luY19zdXBwb3J0IGFzIGNjeHQKZnJvbSBmYXN0YXBpIGltcG9ydCBGYXN0QVBJLCBRdWVyeQpmcm9tIGZhc3RhcGkubWlkZGxld2FyZS5jb3JzIGltcG9ydCBDT1JTTWlkZGxld2FyZQoKZnJvbSBkYXRhYmFzZSBpbXBvcnQgZGIKZnJvbSBsb2dpYy5zdHJhdGVneSBpbXBvcnQgU3RyYXRlZ3lNYW5hZ2VyCmZyb20gbG9naWMuaW5kaWNhdG9ycyBpbXBvcnQgY2hlY2tfdm9sYXRpbGl0eV9vawoKIyBBdXRoIEltcG9ydHMKZnJvbSBmYXN0YXBpIGltcG9ydCBEZXBlbmRzLCBIVFRQRXhjZXB0aW9uLCBzdGF0dXMKaW1wb3J0IGFpb3NxbGl0ZSAjIGZvciBhdXRoIGxvb2t1cAoKbG9hZF9kb3RlbnYoKQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBMT0dHSU5HCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgTE9HR0lORyAoUk9UQVRJTkcpCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmZyb20gbG9nZ2luZy5oYW5kbGVycyBpbXBvcnQgUm90YXRpbmdGaWxlSGFuZGxlcgpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcigiVHJhZGluZ0JvdCIpCmxvZ2dlci5zZXRMZXZlbChsb2dnaW5nLklORk8pCgojIEZpbGUgSGFuZGxlciB3aXRoIFJvdGF0aW9uICgxME1CLCBrZWVwIDUpCmZpbGVfaGFuZGxlciA9IFJvdGF0aW5nRmlsZUhhbmRsZXIoInNlcnZlci5sb2ciLCBtYXhCeXRlcz0xMCoxMDI0KjEwMjQsIGJhY2t1cENvdW50PTUpCmZpbGVfaGFuZGxlci5zZXRGb3JtYXR0ZXIobG9nZ2luZy5Gb3JtYXR0ZXIoJyUoYXNjdGltZSlzIC0gJShuYW1lKXMgLSAlKGxldmVsbmFtZSlzIC0gJShtZXNzYWdlKXMnKSkKCiMgU3RyZWFtIEhhbmRsZXIgKFN0ZG91dCkKc3RyZWFtX2hhbmRsZXIgPSBsb2dnaW5nLlN0cmVhbUhhbmRsZXIoKQpzdHJlYW1faGFuZGxlci5zZXRGb3JtYXR0ZXIobG9nZ2luZy5Gb3JtYXR0ZXIoJyUoYXNjdGltZSlzIC0gJShsZXZlbG5hbWUpcyAtICUobWVzc2FnZSlzJykpCgpsb2dnZXIuYWRkSGFuZGxlcihmaWxlX2hhbmRsZXIpCmxvZ2dlci5hZGRIYW5kbGVyKHN0cmVhbV9oYW5kbGVyKQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBFWENIQU5HRSAoQVNZTkMpCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmV4X2xpdmUgPSBjY3h0LmJpbmFuY2UoewogICAgImFwaUtleSI6IG9zLmdldGVudigiQklOQU5DRV9BUElfS0VZIiksCiAgICAic2VjcmV0Ijogb3MuZ2V0ZW52KCJCSU5BTkNFX1NFQ1JFVF9LRVkiKSwKICAgICJlbmFibGVSYXRlTGltaXQiOiBUcnVlLAogICAgInRpbWVvdXQiOiAyMDAwMCwgCiAgICAib3B0aW9ucyI6IHsKICAgICAgICAiZGVmYXVsdFR5cGUiOiAic3BvdCIsCiAgICAgICAgImFkanVzdEZvclRpbWVEaWZmZXJlbmNlIjogVHJ1ZSwKICAgICAgICAicmVjdldpbmRvdyI6IDYwMDAwCiAgICB9Cn0pCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIExJVkUgLyBQQVBFUiBNT0RFCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tClRSQURFX01PREUgPSBvcy5lbnZpcm9uLmdldCgiVFJBREVfTU9ERSIsICJwYXBlciIpCmxvZ2dlci5pbmZvKGYiVFJBREVfTU9ERToge1RSQURFX01PREV9IikKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgQ09ORklHICYgQ09OU1RBTlRTCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tClNUUkFURUdZX1NNQ181RU1BID0gIlNNQ181RU1BX1JlY2xhaW0iClNUUkFURUdZX05BTUUgPSBTVFJBVEVHWV9TTUNfNUVNQQpBVVRPX1RSQURJTkdfRU5BQkxFRCA9IFRydWUKQkFTRV9CQUxBTkNFID0gMjAwLjAKCk1BWF9TWU1CT0xfRVhQT1NVUkVfVVNEID0gZmxvYXQob3MuZW52aXJvbi5nZXQoIk1BWF9TWU1CT0xfRVhQT1NVUkVfVVNEIiwgIjEyMC4wIikpCk1BWF9IT0xEX1NFQ09ORFMgPSA4ICogMzYwMApNQVhfRkxBVF9QTkxfUENUID0gMC41CldBVENIRVJfSU5URVJWQUwgPSA1ClNUUkFURUdZX0lOVEVSVkFMID0gNjAgIyBDaGVjayBldmVyeSBtaW51dGUKTUlOX0NMT1NFX1FUWV9QQ1QgPSAwLjE1CkNPTU1JU1NJT05fUENUID0gZmxvYXQob3MuZW52aXJvbi5nZXQoIkNPTU1JU1NJT05fUENUIiwgIjAuMDAxIikpCkRFRkFVTFRfU0xJUFBBR0VfUENUID0gZmxvYXQob3MuZW52aXJvbi5nZXQoIkRFRkFVTFRfU0xJUFBBR0VfUENUIiwgIjAuMDAxIikpCgpNQVhfT1JERVJfVVNEID0gZmxvYXQob3MuZW52aXJvbi5nZXQoIk1BWF9PUkRFUl9VU0QiLCAiMTIwLjAiKSkKCiMgW1FVQU5UIFVQREFURVNdIExvdyBmcmVxdWVuY3ksIEhpZ2ggcXVhbGl0eQpNQVhfUE9TSVRJT05fQ09VTlQgPSBpbnQob3MuZW52aXJvbi5nZXQoIk1BWF9QT1NJVElPTl9DT1VOVCIsICIxMiIpKQpNQVhfVFJBREVTX1BFUl9EQVkgPSAzMApQRVJfU1lNQk9MX0NPT0xET1dOX1NFQyA9IDEgKiAzNjAwICMgMSBIb3VyCgpuZWFyX2hpdHMgPSBbXSAjIEdsb2JhbCBzdG9yYWdlIGZvciBpbnRlcmVzdGluZyBzZXR1cHMKc21jX3NjYW5uZXJfY2FjaGUgPSBbXSAjIENhY2hlIGZvciBmcm9udGVuZCBzY2FubmVyCgojIFtIQVJERU5JTkddIEdsb2JhbCBTYWZldHkgU3RhdGUKCmNvbnNlY3V0aXZlX2FwaV9lcnJvcnMgPSAwCnBhdXNlX3VudGlsX3RzID0gMAplcnJfbG9jayA9IGFzeW5jaW8uTG9jaygpCgpkZWYgbWluX25vdGlvbmFsX29rKHN5bWJvbCwgdXNkKToKICAgIG1hcmtldCA9IGV4X2xpdmUubWFya2V0cy5nZXQoc3ltYm9sKQogICAgaWYgbm90IG1hcmtldDoKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBsaW1pdHMgPSBtYXJrZXQuZ2V0KCJsaW1pdHMiLCB7fSkKICAgIGNvc3RfbWluID0gbGltaXRzLmdldCgiY29zdCIsIHt9KS5nZXQoIm1pbiIsIDApCgogICAgcmV0dXJuIHVzZCA+PSBjb3N0X21pbgoKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgR0xPQkFMIFNUQVRFCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmNhY2hlZF9yZWdpbWUgPSB7InZhbHVlIjogIm5ldXRyYWwiLCAidHMiOiAwLCAibXVsdGlwbGllciI6IDAuNX0KcGFydGlhbF90YWtlbl9jYWNoZSA9IHNldCgpICMgU3RvcmVzIElEcyBvZiB0cmFkZXMgdGhhdCBoYXZlIHRha2VuIHBhcnRpYWxzCm1hcmtldF90cmVuZF9zY29yZSA9IDUwCm1hcmtldF90cmVuZF9sYWJlbCA9ICJOZXV0cmFsIgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBGQVNUQVBJIEFQUAojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQphcHAgPSBGYXN0QVBJKCkKYXBwLmFkZF9taWRkbGV3YXJlKAogICAgQ09SU01pZGRsZXdhcmUsCiAgICBhbGxvd19vcmlnaW5zPVsiKiJdLAogICAgYWxsb3dfbWV0aG9kcz1bIioiXSwKICAgIGFsbG93X2hlYWRlcnM9WyIqIl0sCikKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgQVVUSEVOVElDQVRJT04gTE9HSUMKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KZnJvbSBmYXN0YXBpLnNlY3VyaXR5IGltcG9ydCBPQXV0aDJQYXNzd29yZFJlcXVlc3RGb3JtCmZyb20gYXV0aCBpbXBvcnQgY3JlYXRlX2FjY2Vzc190b2tlbiwgZ2V0X2N1cnJlbnRfdXNlciwgdmVyaWZ5X3Bhc3N3b3JkLCBnZXRfcGFzc3dvcmRfaGFzaApmcm9tIHB5ZGFudGljIGltcG9ydCBCYXNlTW9kZWwKCmNsYXNzIFRva2VuKEJhc2VNb2RlbCk6CiAgICBhY2Nlc3NfdG9rZW46IHN0cgogICAgdG9rZW5fdHlwZTogc3RyCgpAYXBwLnBvc3QoIi90b2tlbiIsIHJlc3BvbnNlX21vZGVsPVRva2VuKQphc3luYyBkZWYgbG9naW5fZm9yX2FjY2Vzc190b2tlbihmb3JtX2RhdGE6IE9BdXRoMlBhc3N3b3JkUmVxdWVzdEZvcm0gPSBEZXBlbmRzKCkpOgogICAgIyAxLiBGZXRjaCB1c2VyIGZyb20gREIKICAgIGFzeW5jIHdpdGggYWlvc3FsaXRlLmNvbm5lY3QoInRyYWRlcy5kYiIpIGFzIGRiY29ubjoKICAgICAgICBkYmNvbm4ucm93X2ZhY3RvcnkgPSBhaW9zcWxpdGUuUm93CiAgICAgICAgY3Vyc29yID0gYXdhaXQgZGJjb25uLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gdXNlcnMgV0hFUkUgdXNlcm5hbWUgPSA/IiwgKGZvcm1fZGF0YS51c2VybmFtZSwpKQogICAgICAgIHVzZXIgPSBhd2FpdCBjdXJzb3IuZmV0Y2hvbmUoKQogICAgCiAgICBpZiBub3QgdXNlcjoKICAgICAgICByYWlzZSBIVFRQRXhjZXB0aW9uKHN0YXR1c19jb2RlPTQwMCwgZGV0YWlsPSJJbmNvcnJlY3QgdXNlcm5hbWUgb3IgcGFzc3dvcmQiKQogICAgCiAgICAjIDIuIFZlcmlmeSBQYXNzd29yZAogICAgaWYgbm90IHZlcmlmeV9wYXNzd29yZChmb3JtX2RhdGEucGFzc3dvcmQsIHVzZXJbJ2hhc2hlZF9wYXNzd29yZCddKToKICAgICAgICByYWlzZSBIVFRQRXhjZXB0aW9uKHN0YXR1c19jb2RlPTQwMCwgZGV0YWlsPSJJbmNvcnJlY3QgdXNlcm5hbWUgb3IgcGFzc3dvcmQiKQogICAgCiAgICAjIDMuIENyZWF0ZSBUb2tlbgogICAgYWNjZXNzX3Rva2VuID0gY3JlYXRlX2FjY2Vzc190b2tlbihkYXRhPXsic3ViIjogdXNlclsndXNlcm5hbWUnXSwgInJvbGUiOiB1c2VyWydyb2xlJ119KQogICAgcmV0dXJuIHsiYWNjZXNzX3Rva2VuIjogYWNjZXNzX3Rva2VuLCAidG9rZW5fdHlwZSI6ICJiZWFyZXIifQoKYXN5bmMgZGVmIGdldF9jdXJyZW50X2FkbWluKGN1cnJlbnRfdXNlcjogZGljdCA9IERlcGVuZHMoZ2V0X2N1cnJlbnRfdXNlcikpOgogICAgaWYgY3VycmVudF91c2VyWydyb2xlJ10gIT0gJ2FkbWluJzoKICAgICAgICByYWlzZSBIVFRQRXhjZXB0aW9uKHN0YXR1c19jb2RlPTQwMywgZGV0YWlsPSJBZG1pbiBwcml2aWxlZ2VzIHJlcXVpcmVkIikKICAgIHJldHVybiBjdXJyZW50X3VzZXIKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgSU5JVCBEQgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpAYXBwLm9uX2V2ZW50KCJzdGFydHVwIikKYXN5bmMgZGVmIHN0YXJ0dXAoKToKICAgIGF3YWl0IGRiLmluaXRfZGIoKQogICAgCiAgICAjIFtTQUZFVFldIFN5bmMgREIgd2l0aCBFeGNoYW5nZSBvbiBCb290CiAgICBhc3luY2lvLmNyZWF0ZV90YXNrKHN5bmNfcG9ydGZvbGlvX3dpdGhfZXhjaGFuZ2UoKSkKICAgIAogICAgIyBJbml0IGRlZmF1bHQgc3RhdGUKICAgIHN0YXRlID0gYXdhaXQgZGIuZ2V0X3N0YXRlKCkKICAgIGlmICJhdXRvX3RyYWRpbmciIG5vdCBpbiBzdGF0ZToKICAgICAgICBhd2FpdCBkYi5zZXRfc3RhdGVfa2V5KCJhdXRvX3RyYWRpbmciLCBBVVRPX1RSQURJTkdfRU5BQkxFRCkKICAgIGlmICJkYWlseV9yZWFsaXplZF9wbmwiIG5vdCBpbiBzdGF0ZToKICAgICAgICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgiZGFpbHlfcmVhbGl6ZWRfcG5sIiwgMC4wKQogICAgaWYgInRyYWRlc190b2RheSIgbm90IGluIHN0YXRlOgogICAgICAgICBhd2FpdCBkYi5zZXRfc3RhdGVfa2V5KCJ0cmFkZXNfdG9kYXkiLCAwKQogICAgaWYgImxhc3RfcmVzZXRfZGF0ZSIgbm90IGluIHN0YXRlOgogICAgICAgIGF3YWl0IGRiLnNldF9zdGF0ZV9rZXkoImxhc3RfcmVzZXRfZGF0ZSIsIHN0cihkYXRlLnRvZGF5KCkpKQogICAgaWYgImtpbGxfc3dpdGNoIiBub3QgaW4gc3RhdGU6CiAgICAgICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgia2lsbF9zd2l0Y2giLCBGYWxzZSkKICAgIGlmICJ0cmFkZV91c2QiIG5vdCBpbiBzdGF0ZToKICAgICAgICBhd2FpdCBkYi5zZXRfc3RhdGVfa2V5KCJ0cmFkZV91c2QiLCAyMC4wKQoKICAgICMgW0hBUkRFTklOR10gTW92ZSBsb2FkX21hcmtldHMgdG8gc3RhcnR1cAogICAgdHJ5OgogICAgICAgIGF3YWl0IGV4X2xpdmUubG9hZF9tYXJrZXRzKCkKICAgICAgICBsb2dnZXIuaW5mbygi8J+ToSBbRVhDSEFOR0VdIE1hcmtldHMgbG9hZGVkIHN1Y2Nlc3NmdWxseS4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ2dlci5lcnJvcihmIuKdjCBbRVhDSEFOR0UgSU5JVCBFUlJPUl0ge2V9IikKCiAgICBhc3luY2lvLmNyZWF0ZV90YXNrKHdhdGNoZXJfbG9vcCgpKQogICAgYXN5bmNpby5jcmVhdGVfdGFzayhzdHJhdGVneV9sb29wKCkpCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIFVUSUxTCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmRlZiBzYWZlKHYsIGRlYz0xMCk6CiAgICB0cnk6CiAgICAgICAgdiA9IGZsb2F0KHYpCiAgICAgICAgaWYgbWF0aC5pc25hbih2KSBvciBtYXRoLmlzaW5mKHYpOiByZXR1cm4gMC4wCiAgICAgICAgcmV0dXJuIHJvdW5kKHYsIGRlYykKICAgIGV4Y2VwdDogcmV0dXJuIDAuMAoKZGVmIG51bSh2KToKICAgIHJldHVybiBzYWZlKHYpCgphc3luYyBkZWYgc2FmZV9mZXRjaF90aWNrZXIoc3ltYm9sKToKICAgIGdsb2JhbCBjb25zZWN1dGl2ZV9hcGlfZXJyb3JzLCBwYXVzZV91bnRpbF90cwogICAgdHJ5OgogICAgICAgIHRpY2tlciA9IGF3YWl0IGV4X2xpdmUuZmV0Y2hfdGlja2VyKHN5bWJvbCkKICAgICAgICBhc3luYyB3aXRoIGVycl9sb2NrOgogICAgICAgICAgICBjb25zZWN1dGl2ZV9hcGlfZXJyb3JzID0gMCAKICAgICAgICByZXR1cm4gdGlja2VyCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYXN5bmMgd2l0aCBlcnJfbG9jazoKICAgICAgICAgICAgY29uc2VjdXRpdmVfYXBpX2Vycm9ycyArPSAxCiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYi4pqg77iPIFtBUEkgRVJST1JdIHtzeW1ib2x9OiB7ZX0gKENvbnNlY3V0aXZlOiB7Y29uc2VjdXRpdmVfYXBpX2Vycm9yc30pIikKICAgICAgICAgICAgaWYgY29uc2VjdXRpdmVfYXBpX2Vycm9ycyA+PSA1OgogICAgICAgICAgICAgICAgcGF1c2VfdW50aWxfdHMgPSBkYXRldGltZS5ub3coKS50aW1lc3RhbXAoKSArICgxNSAqIDYwKQogICAgICAgICAgICAgICAgbG9nZ2VyLmNyaXRpY2FsKCLwn5qoIFtDUklUSUNBTF0gNSsgQ29uc2VjdXRpdmUgQVBJIEVycm9ycy4gUGF1c2luZyBmb3IgMTUgbWlucy4iKQogICAgICAgIHJldHVybiBOb25lCgoKCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIERBSUxZIFJFU0VUCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmFzeW5jIGRlZiBkYWlseV9yZXNldF9pZl9uZWVkZWQoKToKICAgIHN0YXRlID0gYXdhaXQgZGIuZ2V0X3N0YXRlKCkKICAgIHRvZGF5ID0gc3RyKGRhdGUudG9kYXkoKSkKICAgICMgSWYgaXQncyBhIG5ldyBkYXksIGNsZWFyIGFsbCBkYWlseSB0cmFja2VycwogICAgaWYgc3RhdGUuZ2V0KCJsYXN0X3Jlc2V0X2RhdGUiKSAhPSB0b2RheToKICAgICAgICBsb2dnZXIuaW5mbyhmIltSRVNFVF0gTmV3IGRheSBkZXRlY3RlZCAoe3RvZGF5fSkuIENsZWFyaW5nIGRhaWx5IHN0YXRzLiIpCiAgICAgICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgibGFzdF9yZXNldF9kYXRlIiwgdG9kYXkpCiAgICAgICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgiZGFpbHlfcmVhbGl6ZWRfcG5sIiwgMC4wKQogICAgICAgIGF3YWl0IGRiLnNldF9zdGF0ZV9rZXkoImRhaWx5X2xvc3Nlc19jb3VudCIsIDApCiAgICAgICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgidHJhZGVzX3RvZGF5IiwgMCkKICAgICAgICBhd2FpdCBkYi5zZXRfc3RhdGVfa2V5KCJsYXN0X3RyYWRlX3RzX21hcCIsIHt9KQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBTVEFURSBIRUxQRVJTCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmFzeW5jIGRlZiBnZXRfYXBwX3N0YXRlKCk6CiAgICByZXR1cm4gYXdhaXQgZGIuZ2V0X3N0YXRlKCkKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgQUNDT1VOVElORwojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQphc3luYyBkZWYgZ2V0X2VxdWl0eV9sb2NrZWRfZnJlZSgpOgogICAgaWYgVFJBREVfTU9ERSA9PSAibGl2ZSI6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEdldCBhbGwgYmFsYW5jZXMKICAgICAgICAgICAgYmFsYW5jZSA9IGF3YWl0IGV4X2xpdmUuZmV0Y2hfYmFsYW5jZSgpCiAgICAgICAgICAgIGZyZWVfdXNkdCA9IHNhZmUoYmFsYW5jZS5nZXQoIlVTRFQiLCB7fSkuZ2V0KCJmcmVlIiwgMCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEZldGNoIHRpY2tlcnMgdG8gdmFsdWUgb3RoZXIgY29pbnMKICAgICAgICAgICAgdGlja2VycyA9IGF3YWl0IGV4X2xpdmUuZmV0Y2hfdGlja2VycygpCiAgICAgICAgICAgIAogICAgICAgICAgICB0b3RhbF9ob2xkaW5nc191c2QgPSAwLjAKICAgICAgICAgICAgZm9yIGNvaW4sIGRhdGEgaW4gYmFsYW5jZVsndG90YWwnXS5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgY29pbiA9PSAnVVNEVCc6IGNvbnRpbnVlCiAgICAgICAgICAgICAgICBxdHkgPSBudW0oZGF0YSkKICAgICAgICAgICAgICAgIGlmIHF0eSA8PSAwOiBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzeW1ib2wgPSBmIntjb2lufS9VU0RUIgogICAgICAgICAgICAgICAgaWYgc3ltYm9sIGluIHRpY2tlcnM6CiAgICAgICAgICAgICAgICAgICAgcHJpY2UgPSBudW0odGlja2Vyc1tzeW1ib2xdWydsYXN0J10pCiAgICAgICAgICAgICAgICAgICAgdG90YWxfaG9sZGluZ3NfdXNkICs9IChxdHkgKiBwcmljZSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHRvdGFsX2VxdWl0eSA9IHNhZmUoZnJlZV91c2R0ICsgdG90YWxfaG9sZGluZ3NfdXNkKQogICAgICAgICAgICAjICJMb2NrZWQiIGluIHRoZSBib3QncyBjb250ZXh0IGlzIHRoZSB2YWx1ZSBvZiBjb2lucyB0aGUgYm90IGlzIE1BTkFHSU5HCiAgICAgICAgICAgIG9wZW5fdHJhZGVzID0gYXdhaXQgZGIuZ2V0X29wZW5fdHJhZGVzKCkKICAgICAgICAgICAgaW52ZXN0ZWRfYnlfYm90ID0gc3VtKHRbJ3VzZWRfdXNkJ10gZm9yIHQgaW4gb3Blbl90cmFkZXMpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdG90YWxfZXF1aXR5LCBzYWZlKGludmVzdGVkX2J5X2JvdCksIGZyZWVfdXNkdCwgIm9rIiwgTm9uZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJbQkFMQU5DRSBFUlJPUl0ge2V9IikKICAgICAgICAgICAgcmV0dXJuIDAuMCwgMC4wLCAwLjAsICJlcnJvciIsIHN0cihlKQoKICAgICMgUGFwZXIgbW9kZSBjYWxjdWxhdGlvbgogICAgb3Blbl90cmFkZXMgPSBhd2FpdCBkYi5nZXRfb3Blbl90cmFkZXMoKQogICAgc3RhdGUgPSBhd2FpdCBkYi5nZXRfc3RhdGUoKQogICAgdG90YWxfcmVhbGl6ZWQgPSBzdGF0ZS5nZXQoInRvdGFsX3JlYWxpemVkX3BubCIsIDAuMCkKICAgIGxvY2tlZCA9IHN1bSh0Wyd1c2VkX3VzZCddIGZvciB0IGluIG9wZW5fdHJhZGVzKQogICAgdW5yZWFsID0gc3VtKHRbJ3VucmVhbGl6ZWRfcG5sJ10gZm9yIHQgaW4gb3Blbl90cmFkZXMpCiAgICAKICAgIGVxdWl0eSA9IEJBU0VfQkFMQU5DRSArIHRvdGFsX3JlYWxpemVkICsgdW5yZWFsCiAgICBmcmVlID0gbWF4KDAuMCwgQkFTRV9CQUxBTkNFICsgdG90YWxfcmVhbGl6ZWQgLSBsb2NrZWQpCiAgICByZXR1cm4gc2FmZShlcXVpdHkpLCBzYWZlKGxvY2tlZCksIHNhZmUoZnJlZSksICJvayIsIE5vbmUKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgUklTSyAmIFVUSUxJVElFUwojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQpkZWYgY2FsY3VsYXRlX3Bvc2l0aW9uX2xpbWl0cyhlcXVpdHk6IGZsb2F0LCBsb2NrZWQ6IGZsb2F0LCBmcmVlOiBmbG9hdCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcGVuX3Bvc2l0aW9uX2NvdW50OiBpbnQpIC0+IHR1cGxlOgogICAgIiIiCiAgICBEeW5hbWljIGNhcGl0YWwgYWxsb2NhdGlvbiB3aXRoIHNhZmV0eSBidWZmZXJzLgogICAgCiAgICBSZXR1cm5zOiAobWF4X3Bvc2l0aW9ucywgdHJhZGVfdXNkKQogICAgCiAgICBTdHJhdGVneToKICAgIC0gVGFyZ2V0IDk1JSBlcXVpdHkgZGVwbG95bWVudCAoNSUgYnVmZmVyKQogICAgLSAxIHBvc2l0aW9uIHBlciAkMzAgZXF1aXR5IChjb25zZXJ2YXRpdmUgc2NhbGluZykKICAgIC0gTWluIDMgcG9zaXRpb25zLCBNYXggMTIgcG9zaXRpb25zCiAgICAtIERpc3RyaWJ1dGUgcmVtYWluaW5nIGNhcGl0YWwgYWNyb3NzIHJlbWFpbmluZyBzbG90cwogICAgIiIiCiAgICAjIER5bmFtaWMgbWF4IHBvc2l0aW9uczogMSBwb3NpdGlvbiBwZXIgJDMwIG9mIGVxdWl0eQogICAgIyBNaW4gMyAoYWxsb3cgc21hbGwgYWNjb3VudHMgdG8gdHJhZGUpLCBNYXggMTIgKHByZXZlbnQgb3Zlci1kaXZlcnNpZmljYXRpb24pCiAgICBjYWxjdWxhdGVkX21heF9wb3MgPSBtYXgoMywgbWluKDEyLCBpbnQoZXF1aXR5IC8gMzApKSkKICAgIAogICAgIyBSZXNwZWN0IGhhcmQgY2FwIGZyb20gY29uZmlnIChiYWNrd2FyZCBjb21wYXRpYmlsaXR5KQogICAgbWF4X3Bvc2l0aW9ucyA9IG1pbihjYWxjdWxhdGVkX21heF9wb3MsIE1BWF9QT1NJVElPTl9DT1VOVCkKICAgIAogICAgIyBbU0FGRVRZXSBEZWZlbnNpdmUgZ3VhcmQ6IHByZXZlbnQgZWRnZS1jYXNlIG92ZXItYWxsb2NhdGlvbgogICAgaWYgb3Blbl9wb3NpdGlvbl9jb3VudCA+PSBtYXhfcG9zaXRpb25zOgogICAgICAgIHJldHVybiBtYXhfcG9zaXRpb25zLCAwLjAKICAgIAogICAgIyBDYWxjdWxhdGUgcGVyLXRyYWRlIGFsbG9jYXRpb24KICAgIHJlbWFpbmluZ19zbG90cyA9IG1heCgxLCBtYXhfcG9zaXRpb25zIC0gb3Blbl9wb3NpdGlvbl9jb3VudCkKICAgIAogICAgIyBVc2UgOTUlIG9mIGZyZWUgY2FwaXRhbCwgZGlzdHJpYnV0ZWQgYWNyb3NzIHJlbWFpbmluZyBzbG90cwogICAgdHJhZGVfdXNkID0gKGZyZWUgKiAwLjk1KSAvIHJlbWFpbmluZ19zbG90cwogICAgCiAgICAjIEVuZm9yY2UgbWluaW11bSB2aWFibGUgdHJhZGUgc2l6ZSAoJDEwKQogICAgdHJhZGVfdXNkID0gbWF4KDEwLjAsIHRyYWRlX3VzZCkKICAgIAogICAgIyBSZXNwZWN0IE1BWF9PUkRFUl9VU0QgaGFyZCBjYXAgKGZyb20gZW52KQogICAgdHJhZGVfdXNkID0gbWluKHRyYWRlX3VzZCwgTUFYX09SREVSX1VTRCkKICAgIAogICAgcmV0dXJuIG1heF9wb3NpdGlvbnMsIHRyYWRlX3VzZAoKYXN5bmMgZGVmIGNhbl9wbGFjZV90cmFkZShzeW1ib2wsIHVzZCwgc3RyYXRlZ3ksIGVxdWl0eSwgbG9ja2VkLCBmcmVlKToKICAgICIiIgogICAgQ2hlY2sgaWYgYSB0cmFkZSBjYW4gYmUgcGxhY2VkIGJhc2VkIG9uIGFsbCBzYWZldHkgY29uc3RyYWludHMuCiAgICAKICAgIEFyZ3M6CiAgICAgICAgZXF1aXR5LCBsb2NrZWQsIGZyZWU6IFByZS1jYWxjdWxhdGVkIGNhcGl0YWwgdmFsdWVzIHRvIGF2b2lkIGR1cGxpY2F0ZSBjYWxscwogICAgIiIiCiAgICBnbG9iYWwgcGF1c2VfdW50aWxfdHMKICAgIHN0YXRlID0gYXdhaXQgZ2V0X2FwcF9zdGF0ZSgpCiAgICAKICAgICMgW0hBUkRFTklOR10gQVBJIFN0YWJpbGl0eSBDaGVjawogICAgaWYgZGF0ZXRpbWUubm93KCkudGltZXN0YW1wKCkgPCBwYXVzZV91bnRpbF90czoKICAgICAgICByZXR1cm4gRmFsc2UsICJhcGlfc3RhYmlsaXR5X3BhdXNlIgoKICAgIGlmIHN0YXRlLmdldCgia2lsbF9zd2l0Y2giKTogcmV0dXJuIEZhbHNlLCAia2lsbF9zd2l0Y2giCgogICAgaWYgdXNkID4gTUFYX09SREVSX1VTRDogcmV0dXJuIEZhbHNlLCAib3JkZXJfdG9vX2xhcmdlIgogICAgaWYgc3RhdGUuZ2V0KCJ0cmFkZXNfdG9kYXkiLCAwKSA+PSBNQVhfVFJBREVTX1BFUl9EQVk6IHJldHVybiBGYWxzZSwgInRyYWRlX2xpbWl0IgoKICAgIG9wZW5fdHJhZGVzID0gYXdhaXQgZGIuZ2V0X29wZW5fdHJhZGVzKCkKICAgIAogICAgIyBbRFlOQU1JQ10gQ2FsY3VsYXRlIHBvc2l0aW9uIGxpbWl0cyBiYXNlZCBvbiBjdXJyZW50IGNhcGl0YWwgKHBhc3NlZCBpbikKICAgIG1heF9wb3NpdGlvbnMsIF8gPSBjYWxjdWxhdGVfcG9zaXRpb25fbGltaXRzKGVxdWl0eSwgbG9ja2VkLCBmcmVlLCBsZW4ob3Blbl90cmFkZXMpKQogICAgCiAgICBpZiBsZW4ob3Blbl90cmFkZXMpID49IG1heF9wb3NpdGlvbnM6IAogICAgICAgIHJldHVybiBGYWxzZSwgZiJtYXhfcG9zaXRpb25zICh7bGVuKG9wZW5fdHJhZGVzKX0ve21heF9wb3NpdGlvbnN9KSIKICAgIAogICAgIyBbUVVBTlRdIFByZXZlbnQgc3RyYXRlZ3kgc3RhY2tpbmcgb24gc2FtZSBzeW1ib2wKICAgIGV4aXN0aW5nX3N5bWJvbF90cmFkZXMgPSBbdCBmb3IgdCBpbiBvcGVuX3RyYWRlcyBpZiB0WydzeW1ib2wnXSA9PSBzeW1ib2xdCiAgICBpZiBleGlzdGluZ19zeW1ib2xfdHJhZGVzOgogICAgICAgIHJldHVybiBGYWxzZSwgInN5bWJvbF9hbHJlYWR5X2hlbGQiCgogICAgIyBbUVVBTlRdIDMtU3RhdGUgUmVnaW1lIEZpbHRlciAtIFJFTU9WRUQgKFVzZXIgUmVxdWVzdCkKICAgIAogICAgIyBbUVVBTlRdIDMtSG91ciBQb3N0LUV4aXQgQ29vbGRvd24KCiAgICAjIFtRVUFOVF0gMy1Ib3VyIFBvc3QtRXhpdCBDb29sZG93bgogICAgc3RhdGUgPSBhd2FpdCBnZXRfYXBwX3N0YXRlKCkKICAgIGNvb2xkb3ducyA9IHN0YXRlLmdldCgiZXhpdF9jb29sZG93bnMiLCB7fSkKICAgIGlmIHN5bWJvbCBpbiBjb29sZG93bnM6CiAgICAgICAgZXhwaXJ5ID0gY29vbGRvd25zW3N5bWJvbF0KICAgICAgICBpZiBkYXRldGltZS5ub3coKS50aW1lc3RhbXAoKSA8IGV4cGlyeToKICAgICAgICAgICAgIHJlbWFpbmluZyA9IGludCgoZXhwaXJ5IC0gZGF0ZXRpbWUubm93KCkudGltZXN0YW1wKCkpIC8gNjApCiAgICAgICAgICAgICByZXR1cm4gRmFsc2UsIGYiZXhpdF9jb29sZG93bl9hY3RpdmVfe3JlbWFpbmluZ31tIgoKICAgICMgW1FVQU5UXSBDb29sZG93biAoNiBIb3VycykKICAgIHRzX21hcCA9IHN0YXRlLmdldCgibGFzdF90cmFkZV90c19tYXAiLCB7fSkKICAgICMgQ2hlY2sgaWYgQU5ZIHN0cmF0ZWd5IHRyYWRlZCB0aGlzIHN5bWJvbCBpbiBsYXN0IDYgaG91cnMKICAgIGZvciBrZXksIGxhc3RfdHMgaW4gdHNfbWFwLml0ZW1zKCk6CiAgICAgICAgaWYgc3ltYm9sIGluIGtleToKICAgICAgICAgICAgaWYgKGRhdGV0aW1lLm5vdygpLnRpbWVzdGFtcCgpIC0gbGFzdF90cykgPCBQRVJfU1lNQk9MX0NPT0xET1dOX1NFQzoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSwgInN5bWJvbF9jb29sZG93biIKCiAgICByZXR1cm4gVHJ1ZSwgIm9rIgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBIRUxQRVJTCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgphc3luYyBkZWYgcmVnaXN0ZXJfdHJhZGVfb3BlbihzeW1ib2wsIHN0cmF0ZWd5KToKICAgIHN0YXRlID0gYXdhaXQgZ2V0X2FwcF9zdGF0ZSgpCiAgICAKICAgICMgVXBkYXRlIHRyYWRlcyB0b2RheQogICAgY3VycmVudF90b2RheSA9IHN0YXRlLmdldCgidHJhZGVzX3RvZGF5IiwgMCkgKyAxCiAgICBhd2FpdCBkYi5zZXRfc3RhdGVfa2V5KCJ0cmFkZXNfdG9kYXkiLCBjdXJyZW50X3RvZGF5KQogICAgCiAgICAjIFVwZGF0ZSBUaW1lc3RhbXAgbWFwCiAgICB0c19tYXAgPSBzdGF0ZS5nZXQoImxhc3RfdHJhZGVfdHNfbWFwIiwge30pCiAgICB0c19tYXBbZiJ7c3RyYXRlZ3l9OntzeW1ib2x9Il0gPSBkYXRldGltZS5ub3coKS50aW1lc3RhbXAoKQogICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgibGFzdF90cmFkZV90c19tYXAiLCB0c19tYXApCgphc3luYyBkZWYgcmVnaXN0ZXJfdHJhZGVfY2xvc2UocG5sLCBzeW1ib2wpOgogICAgc3RhdGUgPSBhd2FpdCBnZXRfYXBwX3N0YXRlKCkKICAgIAogICAgIyBbUVVBTlRdIFNldCAxLUhvdXIgQ29vbGRvd24KICAgIGNvb2xkb3ducyA9IHN0YXRlLmdldCgiZXhpdF9jb29sZG93bnMiLCB7fSkKICAgICMgRXhwaXJlIGluIDEgaG91ciAoMzYwMCBzZWNvbmRzKQogICAgY29vbGRvd25zW3N5bWJvbF0gPSBkYXRldGltZS5ub3coKS50aW1lc3RhbXAoKSArICgxICogMzYwMCkKICAgIGF3YWl0IGRiLnNldF9zdGF0ZV9rZXkoImV4aXRfY29vbGRvd25zIiwgY29vbGRvd25zKQoKICAgICMgRGFpbHkgUG5MCiAgICBkYWlseSA9IHN0YXRlLmdldCgiZGFpbHlfcmVhbGl6ZWRfcG5sIiwgMC4wKSArIHBubAogICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgiZGFpbHlfcmVhbGl6ZWRfcG5sIiwgZGFpbHkpCiAgICAKICAgICMgW1FVQU5UXSBDb3VudCBMb3NzZXMgLSBSRU1PVkVECiAgICAKICAgICMgVG90YWwgUG5MCiAgICB0b3RhbCA9IHN0YXRlLmdldCgidG90YWxfcmVhbGl6ZWRfcG5sIiwgMC4wKSArIHBubAogICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgidG90YWxfcmVhbGl6ZWRfcG5sIiwgdG90YWwpCgphc3luYyBkZWYgc3ltYm9sX2V4cG9zdXJlX29rKHN5bWJvbCwgYWRkaXRpb25hbF91c2QpOgogICAgdHJhZGVzID0gYXdhaXQgZGIuZ2V0X29wZW5fdHJhZGVzKCkKICAgIGV4cG9zdXJlID0gc3VtKHRbJ3VzZWRfdXNkJ10gZm9yIHQgaW4gdHJhZGVzIGlmIHRbJ3N5bWJvbCddID09IHN5bWJvbCkKICAgIHJldHVybiAoZXhwb3N1cmUgKyBhZGRpdGlvbmFsX3VzZCkgPD0gTUFYX1NZTUJPTF9FWFBPU1VSRV9VU0QKCiMgW0hBUkRFTklOR10gUHJlLUJ1eSBTYW5pdHkgQ2hlY2tzCmRlZiBidXlfc2FuaXR5X2NoZWNrKHN5bWJvbCwgcHJpY2UsIHF0eSwgdXNkLCBzbCwgdHApOgogICAgaWYgcHJpY2UgPD0gMCBvciBxdHkgPD0gMDogcmV0dXJuIEZhbHNlLCAiaW52YWxpZF9wcmljZV9vcl9xdHkiCiAgICBpZiB1c2QgPCA1LjA6IHJldHVybiBGYWxzZSwgIm9yZGVyX3ZhbHVlX3Rvb19sb3ciCiAgICBpZiBzbCA+IDAgYW5kIHNsID49IHByaWNlOiByZXR1cm4gRmFsc2UsIGYiaW52YWxpZF9zbF9kaXJlY3Rpb24gKFNMOiB7c2x9LCBQcmljZToge3ByaWNlfSkiCiAgICBpZiB0cCA+IDAgYW5kIHRwIDw9IHByaWNlOiByZXR1cm4gRmFsc2UsIGYiaW52YWxpZF90cF9kaXJlY3Rpb24gKFRQOiB7dHB9LCBQcmljZToge3ByaWNlfSkiCiAgICByZXR1cm4gVHJ1ZSwgIm9rIgoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBbU0FGRVRZXSBQb3J0Zm9saW8gU3luYwojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQphc3luYyBkZWYgc3luY19wb3J0Zm9saW9fd2l0aF9leGNoYW5nZSgpOgogICAgIiIiCiAgICBDaGVja3MgaWYgREIgb3BlbiB0cmFkZXMgYWN0dWFsbHkgZXhpc3Qgb24gQmluYW5jZS4KICAgIERlbGV0ZXMgdGhlbSBpZiB0aGV5IGFyZSBwaGFudG9tIChwaGFudG9tID0gREIgaGFzIGl0LCBFeGNoYW5nZSBkb2VzbnQpLgogICAgIiIiCiAgICBpZiBUUkFERV9NT0RFICE9ICJsaXZlIjoKICAgICAgICByZXR1cm4KCiAgICB0cnk6CiAgICAgICAgIyAxLiBGZXRjaCBEQiBTdGF0ZQogICAgICAgIGRiX3RyYWRlcyA9IGF3YWl0IGRiLmdldF9vcGVuX3RyYWRlcygpCiAgICAgICAgaWYgbm90IGRiX3RyYWRlczogcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyAyLiBGZXRjaCBFeGNoYW5nZSBTdGF0ZQogICAgICAgIGJhbCA9IGF3YWl0IGV4X2xpdmUuZmV0Y2hfYmFsYW5jZSgpCiAgICAgICAgdG90YWwgPSBiYWwuZ2V0KCd0b3RhbCcsIHt9KQogICAgICAgIAogICAgICAgICMgMy4gQ29tcGFyZSBhbmQgUHJ1bmUKICAgICAgICBmb3IgdCBpbiBkYl90cmFkZXM6CiAgICAgICAgICAgIGNvaW4gPSB0WydzeW1ib2wnXS5zcGxpdCgnLycpWzBdCiAgICAgICAgICAgIGRiX3F0eSA9IHRbJ3F0eSddCiAgICAgICAgICAgIHJlYWxfcXR5ID0gdG90YWwuZ2V0KGNvaW4sIDAuMCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgW0hBUkRFTklOR10gU3RyaWN0IFBoYW50b20gRGV0ZWN0aW9uIHdpdGggRHVzdCBDb25zaWRlcmF0aW9uCiAgICAgICAgICAgICMgUnVsZTogSWYgQmluYW5jZSBob2xkaW5nIGlzIGVmZmVjdGl2ZWx5IHplcm8gKDwgMWUtOCkgT1Igb25seSBkdXN0IHJlbWFpbnMgKDwgNSUgb2YgREIgcXR5KSwKICAgICAgICAgICAgIyB0cmVhdCBpdCBhcyBhIGNsb3NlZCBwb3NpdGlvbiAocGhhbnRvbSkuCiAgICAgICAgICAgIGlmIHJlYWxfcXR5IDw9IDFlLTggb3IgcmVhbF9xdHkgPCAoZGJfcXR5ICogMC4wNSk6CiAgICAgICAgICAgICAgICAjIFtSQUNFIENPTkRJVElPTiBGSVhdIFJlLWNoZWNrIERCIHN0YXR1cyBiZWZvcmUgY2xvc2luZwogICAgICAgICAgICAgICAgY3VycmVudF9kYl90cmFkZSA9IGF3YWl0IGRiLmdldF90cmFkZSh0WydpZCddKQogICAgICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfZGJfdHJhZGUgb3IgY3VycmVudF9kYl90cmFkZVsnc3RhdHVzJ10gIT0gJ29wZW4nOgogICAgICAgICAgICAgICAgICAgICMgVHJhZGUgd2FzIGxpa2VseSBjbG9zZWQgYnkgZXhlY3V0ZV9zZWxsIHdoaWxlIHdlIHdlcmUgZmV0Y2hpbmcgYmFsYW5jZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJbU1lOQ10gUEhBTlRPTS9EVVNUIERFVEVDVEVEOiB7dFsnc3ltYm9sJ119IChEQjoge2RiX3F0eX0gfCBSZWFsOiB7cmVhbF9xdHl9KS4gQ2xvc2luZyBpbiBEQi4iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFtGSVhdIERvIG5vdCBkZWxldGUuIFByZXNlcnZlIGhpc3RvcnkuIE1hcmsgYXMgY2xvc2VkIHdpdGggMCBQbkwuCiAgICAgICAgICAgICAgICAjIFVzZSB0ZW1wb3JhcnkgY29ubmVjdGlvbiBmb3Igc2FmZXR5IGFzIGJlZm9yZS4KICAgICAgICAgICAgICAgIGltcG9ydCBhaW9zcWxpdGUKICAgICAgICAgICAgICAgIGFzeW5jIHdpdGggYWlvc3FsaXRlLmNvbm5lY3QoInRyYWRlcy5kYiIpIGFzIGNvbm46CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY29ubi5leGVjdXRlKCIiIgogICAgICAgICAgICAgICAgICAgICAgICBVUERBVEUgdHJhZGVzIAogICAgICAgICAgICAgICAgICAgICAgICBTRVQgc3RhdHVzPSdjbG9zZWQnLCBleGl0X3RpbWU9PywgcG5sPTAsIGV4aXRfcHJpY2U9MCwgZmVlc191c2Q9MCAKICAgICAgICAgICAgICAgICAgICAgICAgV0hFUkUgaWQ9PwogICAgICAgICAgICAgICAgICAgICIiIiwgKGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpLmlzb2Zvcm1hdCgpLCB0WydpZCddKSkKICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ2dlci5lcnJvcihmIltTWU5DXSBFcnJvciBzeW5jaW5nIHBvcnRmb2xpbzoge2V9IikKCiAgICAjIDQuIFtSRVZFUlNFIFNZTkNdIEltcG9ydCBNaXNzaW5nIFRyYWRlcyAoRXhjaGFuZ2UgLT4gREIpCiAgICAjIElmIHdlIGhhdmUgYSBiYWxhbmNlIG9uIEV4Y2hhbmdlIGJ1dCBOTyB0cmFkZSBpbiBEQiwgaW1wb3J0IGl0LgogICAgdHJ5OgogICAgICAgICMgUmUtZmV0Y2ggYmFsYW5jZSB0byBiZSBzYWZlIChvciByZXVzZSBpZiBjb25maWRlbnQpCiAgICAgICAgIyBXZSBpdGVyYXRlIHRocm91Z2ggdGhlICd0b3RhbCcgYmFsYW5jZSB3ZSBhbHJlYWR5IGZldGNoZWQKICAgICAgICBmb3IgY29pbiwgcXR5IGluIHRvdGFsLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIGNvaW4gPT0gJ1VTRFQnOiBjb250aW51ZQogICAgICAgICAgICBpZiBxdHkgPD0gMDogY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ29uc3RydWN0IFN5bWJvbCAoQXNzdW1wdGlvbjogVVNEVCBwYWlyKQogICAgICAgICAgICBzeW1ib2wgPSBmIntjb2lufS9VU0RUIgogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaGVjayBpZiB0aGlzIHN5bWJvbCBleGlzdHMgaW4gb3VyIE9wZW4gREIgVHJhZGVzCiAgICAgICAgICAgIGZvdW5kID0gRmFsc2UKICAgICAgICAgICAgZm9yIHQgaW4gZGJfdHJhZGVzOgogICAgICAgICAgICAgICAgaWYgdFsnc3ltYm9sJ10gPT0gc3ltYm9sOgogICAgICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFtIQVJERU5JTkddIERvdWJsZSBDaGVjayBEQiBiZWZvcmUgSW1wb3J0IChBbnRpLVJhY2UgQ29uZGl0aW9uKQogICAgICAgICAgICBpZiBub3QgZm91bmQ6CiAgICAgICAgICAgICAgICAjIFF1ZXJ5IERCIGRpcmVjdGx5IHRvIGJlIGFic29sdXRlbHkgc3VyZSBpdCB3YXNuJ3QganVzdCBvcGVuZWQKICAgICAgICAgICAgICAgICMgYnkgdGhlIFN0cmF0ZWd5IE1hbmFnZXIgaW4gdGhlIGxhc3QgZmV3IG1pbGxpc2Vjb25kcwogICAgICAgICAgICAgICAgY2hlY2tfc2NhbiA9IGF3YWl0IGRiLmdldF9vcGVuX3RyYWRlcygpICMgUmVmcmVzaAogICAgICAgICAgICAgICAgZm9yIHNjYW5fdCBpbiBjaGVja19zY2FuOgogICAgICAgICAgICAgICAgICAgIGlmIHNjYW5fdFsnc3ltYm9sJ10gPT0gc3ltYm9sOgogICAgICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgICAgICAjIENoZWNrIGlmIHRoZSB2YWx1ZSBpcyBzaWduaWZpY2FudCAoPiAkNSkKICAgICAgICAgICAgICAgICAjIFdlIG5lZWQgY3VycmVudCBwcmljZQogICAgICAgICAgICAgICAgIHRpY2tlciA9IGF3YWl0IHNhZmVfZmV0Y2hfdGlja2VyKHN5bWJvbCkKICAgICAgICAgICAgICAgICBpZiBub3QgdGlja2VyOiBjb250aW51ZQogICAgICAgICAgICAgICAgIHByaWNlID0gbnVtKHRpY2tlclsnbGFzdCddKQogICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIHZhbHVlX3VzZCA9IHF0eSAqIHByaWNlCiAgICAgICAgICAgICAgICAgaWYgdmFsdWVfdXNkID4gNS4wOgogICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIvCfk6UgW1NZTkNdIEZvdW5kIE9ycGhhbmVkIFBvc2l0aW9uIG9uIEV4Y2hhbmdlOiB7c3ltYm9sfSAoUXR5OiB7cXR5fSkuIEltcG9ydGluZy4uLiIpCiAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAjIENyZWF0ZSBUcmFkZSBFbnRyeQogICAgICAgICAgICAgICAgICAgICAjIFdlIGRvbid0IGtub3cgb3JpZ2luYWwgZW50cnksIHNvIHdlIHVzZSBjdXJyZW50IHByaWNlIGFzIHJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgICAjIG9yIG1heWJlIDAuIEl0J3MgYmV0dGVyIHRvIHVzZSBjdXJyZW50IHByaWNlIHNvIFBuTCBzdGFydHMgYXQgMD8KICAgICAgICAgICAgICAgICAgICAgIyBBY3R1YWxseSwgUG5MIHdpbGwgYmUgd3JvbmcgaW5pdGlhbGx5LCBidXQgYmV0dGVyIHRoYW4gbm90IHRyYWNraW5nIGl0LgogICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgbmV3X3RyYWRlID0gewogICAgICAgICAgICAgICAgICAgICAgICAiaWQiOiBzdHIodXVpZC51dWlkNCgpKSwKICAgICAgICAgICAgICAgICAgICAgICAgInRpbWUiOiBkYXRldGltZS5ub3codGltZXpvbmUudXRjKS5pc29mb3JtYXQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgInN5bWJvbCI6IHN5bWJvbCwKICAgICAgICAgICAgICAgICAgICAgICAgInNpZGUiOiAiYnV5IiwKICAgICAgICAgICAgICAgICAgICAgICAgInN0cmF0ZWd5IjogIk1hbnVhbF9JbXBvcnQiLCAjIGRpc3RpbmN0IHRhZwogICAgICAgICAgICAgICAgICAgICAgICAiZW50cnlfcHJpY2UiOiBwcmljZSwgIyBBcHByb3hpbWF0ZQogICAgICAgICAgICAgICAgICAgICAgICAicXR5IjogcXR5LAogICAgICAgICAgICAgICAgICAgICAgICAidXNlZF91c2QiOiB2YWx1ZV91c2QsCiAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAib3BlbiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJwbmwiOiAwLjAsCiAgICAgICAgICAgICAgICAgICAgICAgICJzbCI6IDAuMCwKICAgICAgICAgICAgICAgICAgICAgICAgInRwIjogMC4wLAogICAgICAgICAgICAgICAgICAgICAgICAiZXhpdF9wcmljZSI6IDAuMCwKICAgICAgICAgICAgICAgICAgICAgICAgImN1cnJlbnRfcHJpY2UiOiBwcmljZSwKICAgICAgICAgICAgICAgICAgICAgICAgInVucmVhbGl6ZWRfcG5sIjogMC4wLAogICAgICAgICAgICAgICAgICAgICAgICAiZmVlc191c2QiOiAwLjAsCiAgICAgICAgICAgICAgICAgICAgICAgICJoaWdoZXN0X3ByaWNlIjogcHJpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0cmFpbF9hY3RpdmUiOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgInRyYWlsX3NsIjogMC4wCiAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgYXdhaXQgZGIuYWRkX3RyYWRlKG5ld190cmFkZSkKICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinIUgW0lNUE9SVF0gU3VjY2Vzc2Z1bGx5IGltcG9ydGVkIHtzeW1ib2x9IikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nZ2VyLmVycm9yKGYiW1JFVkVSU0UgU1lOQ10gRXJyb3I6IHtlfSIpCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKIyBFWEVDVVRJT04gJiBPUkRFUiBNQU5BR0VNRU5UCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmFzeW5jIGRlZiBleGVjdXRlX2J1eShzeW1ib2wsIHNsX3BjdCwgdHBfcGN0LCBzdHJhdGVneSwgc2xfYWJzb2x1dGU9Tm9uZSwgYnRjX211bHRpcGxpZXI9MS4wKToKICAgIGF3YWl0IGRhaWx5X3Jlc2V0X2lmX25lZWRlZCgpCiAgICAKICAgIHRpY2tlciA9IGF3YWl0IHNhZmVfZmV0Y2hfdGlja2VyKHN5bWJvbCkKICAgIGlmIG5vdCB0aWNrZXI6IHJldHVybgogICAgcHJpY2UgPSBudW0odGlja2VyWyJsYXN0Il0pCiAgICAKICAgICMgW1FVQU5UXSAxLiBDYWxjdWxhdGUgUmlzayBEaXN0YW5jZQogICAgaWYgc2xfYWJzb2x1dGUgaXMgbm90IE5vbmU6CiAgICAgICAgc2wgPSBzbF9hYnNvbHV0ZQogICAgICAgIGlmIHNsID49IHByaWNlOiAKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJbQlVZIFNLSVBdIEludmFsaWQgQWJzb2x1dGUgU0wge3NsfSA+PSBQcmljZSB7cHJpY2V9IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgc2xfZGlzdF91c2QgPSBwcmljZSAtIHNsCiAgICAgICAgc2xfcGN0X2NhbGMgPSAoc2xfZGlzdF91c2QgLyBwcmljZSkgKiAxMDAKICAgIGVsaWYgc2xfcGN0IGlzIG5vdCBOb25lOgogICAgICAgIHNsX2Rpc3RfdXNkID0gcHJpY2UgKiAoc2xfcGN0IC8gMTAwKQogICAgICAgIHNsID0gcHJpY2UgLSBzbF9kaXN0X3VzZAogICAgZWxzZToKICAgICAgICBsb2dnZXIuZXJyb3IoZiJbQlVZIEZBSUxdIHtzeW1ib2x9OiBObyBTTCBwcm92aWRlZCAoQWJzb2x1dGUgb3IgJSkuIikKICAgICAgICByZXR1cm4KICAgIAogICAgIyBbUVVBTlRdIDIuIFBvc2l0aW9uIFNpemluZyAoUmlzayBYJSBvZiBFcXVpdHkgKiBCVEMgUmVnaW1lKQogICAgZXF1aXR5LCBsb2NrZWQsIGZyZWUsIF8sIF8gPSBhd2FpdCBnZXRfZXF1aXR5X2xvY2tlZF9mcmVlKCkKICAgIAogICAgIyBbRkVBVFVSRV0gRHluYW1pYyBSaXNrICUKICAgIHN0YXRlID0gYXdhaXQgZ2V0X2FwcF9zdGF0ZSgpCiAgICB1c2VyX3Jpc2sgPSBmbG9hdChzdGF0ZS5nZXQoInJpc2tfcGN0IiwgMC4wMikpICMgRGVmYXVsdCAyJQogICAgCiAgICBCQVNFX1JJU0sgPSB1c2VyX3Jpc2sgCiAgICBmaW5hbF9yaXNrX3BjdCA9IEJBU0VfUklTSyAqIGJ0Y19tdWx0aXBsaWVyCiAgICByaXNrX2Ftb3VudCA9IGVxdWl0eSAqIGZpbmFsX3Jpc2tfcGN0CiAgICAKICAgICMgUXR5ID0gUmlzayAvIERpc3RhbmNlCiAgICBpZiBzbF9kaXN0X3VzZCA+IDA6CiAgICAgICAgdGFyZ2V0X3F0eSA9IHJpc2tfYW1vdW50IC8gc2xfZGlzdF91c2QKICAgICAgICByaXNrX2Jhc2VkX3VzZCA9IHRhcmdldF9xdHkgKiBwcmljZQogICAgZWxzZToKICAgICAgICAjIEZhbGxiYWNrIGlmIFNMIGlzIDAgCiAgICAgICAgcmlza19iYXNlZF91c2QgPSAyMC4wIAogICAgICAgIAogICAgIyBbUVVBTlRdIDMuIEFwcGx5IExpbWl0cwogICAgc3RhdGUgPSBhd2FpdCBnZXRfYXBwX3N0YXRlKCkKICAgIHVzZXJfY2FwX3VzZCA9IGZsb2F0KHN0YXRlLmdldCgidHJhZGVfdXNkIiwgMjAuMCkpCiAgICAKICAgICMgW1JVTEVdIEhhcm1vbml6ZWQgU2l6aW5nIExvZ2ljCiAgICAjIFdlIHRha2UgdGhlIFNNQUxMRVNUIG9mIHRocmVlIHZhbHVlczoKICAgICMgMS4gUmlzay1CYXNlZCBTaXplIChDYWxjdWxhdGVkIHRvIGxvc2UgMiUpCiAgICAjIDIuIFVzZXIgU2FmZXR5IENhcCAoRnJvbSBDb250cm9sIFBhbmVsKQogICAgIyAzLiA1MCUgb2YgRXF1aXR5IChCbG93LXVwIFByZXZlbnRpb24pCiAgICAKICAgIGVxdWl0eV9jYXAgPSBlcXVpdHkgKiAwLjUwCiAgICAKICAgICMgQ2FsY3VsYXRlIEZpbmFsIFNpemUKICAgIHVzZCA9IG1pbihyaXNrX2Jhc2VkX3VzZCwgdXNlcl9jYXBfdXNkLCBlcXVpdHlfY2FwLCBmcmVlICogMC45OCkKICAgIAogICAgIyBMb2cgaWYgd2UgYXJlIGJlaW5nIGNhcHBlZCBieSBzYWZldHkgcnVsZXMKICAgIGlmIHVzZCA8IHJpc2tfYmFzZWRfdXNkOgogICAgICAgICByZWFzb24gPSAiVXNlciBDYXAiIGlmIHVzZCA9PSB1c2VyX2NhcF91c2QgZWxzZSAiNTAlIFBvcnRmb2xpbyBMaW1pdCIKICAgICAgICAgbG9nZ2VyLmluZm8oZiLwn5uh77iPIFtTQUZFVFkgUkVTSVpFXSB7c3ltYm9sfTogUmlza1NpemUgJHtyaXNrX2Jhc2VkX3VzZDouMmZ9IC0+IENhcHBlZCBhdCAke3VzZDouMmZ9ICh7cmVhc29ufSkiKQogICAgCiAgICBsb2dnZXIuaW5mbyhmIuKalu+4jyBbU0laSU5HXSB7c3ltYm9sfSB8IFJpc2s6IHtmaW5hbF9yaXNrX3BjdCoxMDA6LjFmfSUgKCR7cmlza19hbW91bnQ6LjJmfSkgfCBTaXplOiAke3VzZDouMmZ9IikKCiAgICBpZiB1c2QgPCA1OiAKICAgICAgICBsb2dnZXIuaW5mbyhmIltCVVkgU0tJUF0ge3N5bWJvbH06IFNpemUgJHt1c2Q6LjJmfSB0b28gc21hbGwiKQogICAgICAgIHJldHVybiAjIFRvbyBzbWFsbAogICAgCiAgICBpZiBub3QgYXdhaXQgc3ltYm9sX2V4cG9zdXJlX29rKHN5bWJvbCwgdXNkKTogcmV0dXJuCiAgICBvaywgcmVhc29uID0gYXdhaXQgY2FuX3BsYWNlX3RyYWRlKHN5bWJvbCwgdXNkLCBzdHJhdGVneSwgZXF1aXR5LCBsb2NrZWQsIGZyZWUpCiAgICBpZiBub3Qgb2s6CiAgICAgICAgbG9nZ2VyLmluZm8oZiJbQlVZIFNLSVBdIHtzeW1ib2x9OiB7cmVhc29ufSIpCiAgICAgICAgcmV0dXJuCgogICAgIyBbUlVMRV0gRml4ZWQgUmlzayA6IFJld2FyZCA9IDEgOiAyCiAgICAjIFRQID0gRW50cnkgKyAoMiAqIFNMIERpc3RhbmNlKQogICAgaWYgc2xfZGlzdF91c2QgPiAwOgogICAgICAgIHRwX3ByaWNlID0gcHJpY2UgKyAoMiAqIHNsX2Rpc3RfdXNkKQogICAgICAgIHRwID0gbnVtKHRwX3ByaWNlKQogICAgICAgIGxvZ2dlci5pbmZvKGYi8J+OryBbVFAgQ0FMQ10gMToyIFJSIC0+IFByb2ZpdCBUYXJnZXQgQCB7dHB9IikKICAgIGVsc2U6CiAgICAgICAgdHAgPSAwLjAKCiAgICAjIC4uLiAodGlja2VyIGZldGNoIHdhcyBtb3ZlZCB1cCkKICAgIAogICAgIyBFeGVjdXRpb24KICAgIGlmIFRSQURFX01PREUgPT0gImxpdmUiOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBbSEFSREVOSU5HXSBTYW5pdHkgY2hlY2sgYmVmb3JlIG9yZGVyCiAgICAgICAgICAgICMgU0wgaXMgYWxyZWFkeSBjYWxjdWxhdGVkIGFib3ZlCiAgICAgICAgICAgICMgVFAgaXMgY2FsY3VsYXRlZCBhYm92ZSAoMToyIGZpeGVkKQogICAgICAgICAgICBxdHlfcHJlID0gdXNkIC8gcHJpY2UKICAgICAgICAgICAgCiAgICAgICAgICAgIG9rLCBtc2cgPSBidXlfc2FuaXR5X2NoZWNrKHN5bWJvbCwgcHJpY2UsIHF0eV9wcmUsIHVzZCwgc2wsIHRwKQogICAgICAgICAgICBpZiBub3Qgb2s6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLinYwgW1NBTklUWSBDQU5DRUxdIHtzeW1ib2x9OiB7bXNnfSIpCiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgICMgW0hBUkRFTklOR10gTW92ZSBsb2FkX21hcmtldHMgdG8gc3RhcnR1cCBhbmQgcmVtb3ZlIGhlcmUKICAgICAgICAgICAgYW1vdW50ID0gbnVtKGV4X2xpdmUuYW1vdW50X3RvX3ByZWNpc2lvbihzeW1ib2wsIHF0eV9wcmUpKQogICAgICAgICAgICAKICAgICAgICAgICAgb3JkZXIgPSBhd2FpdCBleF9saXZlLmNyZWF0ZV9tYXJrZXRfYnV5X29yZGVyKHN5bWJvbCwgYW1vdW50KQogICAgICAgICAgICAjIFN1Y2Nlc3M6IHJlc2V0IGdsb2JhbCBlcnJvciBjb3VudGVyCiAgICAgICAgICAgIGdsb2JhbCBjb25zZWN1dGl2ZV9hcGlfZXJyb3JzCiAgICAgICAgICAgIGFzeW5jIHdpdGggZXJyX2xvY2s6CiAgICAgICAgICAgICAgICBjb25zZWN1dGl2ZV9hcGlfZXJyb3JzID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgZXhlY19wcmljZSA9IG51bShvcmRlci5nZXQoImF2ZXJhZ2UiKSBvciBvcmRlci5nZXQoInByaWNlIikgb3IgcHJpY2UpCiAgICAgICAgICAgIHF0eSA9IG51bShvcmRlci5nZXQoImZpbGxlZCIpIG9yIDApCiAgICAgICAgICAgICMgLi4uIHJlc3Qgb2YgdGhlIGV4dHJhY3Rpb24gbG9naWMgLi4uCiAgICAgICAgICAgIGlmIHF0eSA8PSAwOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9yZGVyID0gYXdhaXQgZXhfbGl2ZS5mZXRjaF9vcmRlcihvcmRlclsnaWQnXSwgc3ltYm9sKQogICAgICAgICAgICAgICAgICAgIHF0eSA9IG51bShvcmRlci5nZXQoImZpbGxlZCIpIG9yIDApCiAgICAgICAgICAgICAgICAgICAgZXhlY19wcmljZSA9IG51bShvcmRlci5nZXQoImF2ZXJhZ2UiKSBvciBvcmRlci5nZXQoInByaWNlIikgb3IgcHJpY2UpCiAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgCiAgICAgICAgICAgICMgW0hBUkRFTklOR10gVmFsaWRhdGUgVHJhZGUgUmVhbGl0eQogICAgICAgICAgICAjIElmIGV4Y2hhbmdlIGdhdmUgdXMgMCBxdHkgb3IgPCAkNSB2YWx1ZSwgRE8gTk9UIFRSQUNLIElULgogICAgICAgICAgICAjIFRoaXMgcHJldmVudHMgMC1xdHkgIlBoYW50b20gVHJhZGVzIiBmcm9tIGhpdHRpbmcgdGhlIERCLgogICAgICAgICAgICBpZiBxdHkgPD0gMWUtOCBvciBzYWZlKGV4ZWNfcHJpY2UgKiBxdHkpIDwgNS4wOgogICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIuKdjCBbUEhBTlRPTSBCVVkgREVURUNURURdIHtzeW1ib2x9OiBRdHkge3F0eX0sIENvc3Qge3NhZmUoZXhlY19wcmljZSAqIHF0eSl9LiBBYm9ydGluZyBEQiBpbnNlcnQuIikKICAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgIHVzZWQgPSBzYWZlKGV4ZWNfcHJpY2UgKiBxdHkpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIFtUUkFERSBPUEVOXSB7c3RyYXRlZ3l9IHwge3N5bWJvbH0gQCB7ZXhlY19wcmljZX0gfCBRdHk6IHtxdHl9IHwgU0w6IHtzbH0gfCBUUDoge3RwfSIpCgogICAgICAgICAgICAjIEZlZSBoYW5kbGluZwogICAgICAgICAgICBmZWVfb2JqID0gb3JkZXIuZ2V0KCdmZWUnKQogICAgICAgICAgICBpZiBmZWVfb2JqIGFuZCBmZWVfb2JqLmdldCgnY29zdCcpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZmVlX2Nvc3QgPSBudW0oZmVlX29ialsnY29zdCddKQogICAgICAgICAgICAgICAgZmVlX2N1cnJlbmN5ID0gZmVlX29iai5nZXQoJ2N1cnJlbmN5JykKICAgICAgICAgICAgICAgIGlmIGZlZV9jdXJyZW5jeSBhbmQgZmVlX2N1cnJlbmN5ID09IHN5bWJvbC5zcGxpdCgnLycpWzBdOgogICAgICAgICAgICAgICAgICAgIGZlZXMgPSBzYWZlKGZlZV9jb3N0ICogZXhlY19wcmljZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZmVlcyA9IHNhZmUoZmVlX2Nvc3QpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBmZWVzID0gc2FmZSh1c2VkICogQ09NTUlTU0lPTl9QQ1QpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBhc3luYyB3aXRoIGVycl9sb2NrOgogICAgICAgICAgICAgICAgY29uc2VjdXRpdmVfYXBpX2Vycm9ycyArPSAxCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIuKdjCBbQlVZIEZBSUxdIHtzeW1ib2x9OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4KICAgIGVsc2U6CiAgICAgICAgIyBQYXBlcgogICAgICAgIGV4ZWNfcHJpY2UgPSBwcmljZQogICAgICAgIHF0eSA9IHNhZmUodXNkIC8gcHJpY2UpCiAgICAgICAgdXNlZCA9IHNhZmUocXR5ICogZXhlY19wcmljZSkKICAgICAgICBmZWVzID0gc2FmZSh1c2VkICogQ09NTUlTU0lPTl9QQ1QpCiAgICAgICAgc2wgPSBzYWZlKGV4ZWNfcHJpY2UgKiAoMSAtIHNsX3BjdCAvIDEwMCkpIGlmIHNsX3BjdCBlbHNlIDAuMAogICAgICAgIHRwID0gc2FmZShleGVjX3ByaWNlICogKDEgKyB0cF9wY3QgLyAxMDApKSBpZiB0cF9wY3QgZWxzZSAwLjAKICAgICAgICBsb2dnZXIuaW5mbyhmIvCfk5EgW1BBUEVSIE9QRU5dIHtzdHJhdGVneX0gfCB7c3ltYm9sfSBAIHtleGVjX3ByaWNlfSB8IFF0eToge3F0eX0gfCBTTDoge3NsfSB8IFRQOiB7dHB9IikKCiAgICAjIE1lcmdlIG9yIE5ldwogICAgZXhpc3RpbmcgPSBhd2FpdCBkYi5nZXRfdHJhZGVzX2J5X3N0YXR1c19zeW1ib2xfc3RyYXRlZ3koIm9wZW4iLCBzeW1ib2wsIHN0cmF0ZWd5KQogICAgCiAgICBpZiBleGlzdGluZzoKICAgICAgICBwb3MgPSBleGlzdGluZ1swXQogICAgICAgIG9sZF9xdHksIG9sZF9lbnRyeSA9IHBvc1sncXR5J10sIHBvc1snZW50cnlfcHJpY2UnXQogICAgICAgIHRvdGFsX3F0eSA9IHNhZmUob2xkX3F0eSArIHF0eSkKICAgICAgICBhdmdfZW50cnkgPSBzYWZlKCgob2xkX3F0eSAqIG9sZF9lbnRyeSkgKyAocXR5ICogZXhlY19wcmljZSkpIC8gdG90YWxfcXR5KQogICAgICAgIAogICAgICAgIGF3YWl0IGRiLnVwZGF0ZV90cmFkZShwb3NbJ2lkJ10sIHsKICAgICAgICAgICAgInF0eSI6IHRvdGFsX3F0eSwKICAgICAgICAgICAgImVudHJ5X3ByaWNlIjogYXZnX2VudHJ5LAogICAgICAgICAgICAidXNlZF91c2QiOiBzYWZlKHBvc1sndXNlZF91c2QnXSArIHVzZWQpLAogICAgICAgICAgICAiZmVlc191c2QiOiBzYWZlKHBvc1snZmVlc191c2QnXSArIGZlZXMpLAogICAgICAgICAgICAic2wiOiBtaW4ocG9zWydzbCddLCBzbCkgaWYgc2wgYW5kIHBvc1snc2wnXSBlbHNlIChwb3NbJ3NsJ10gb3Igc2wpLAogICAgICAgICAgICAidHAiOiBtYXgocG9zWyd0cCddLCB0cCkgaWYgdHAgYW5kIHBvc1sndHAnXSBlbHNlIChwb3NbJ3RwJ10gb3IgdHApCiAgICAgICAgfSkKICAgIGVsc2U6CiAgICAgICAgdHJhZGUgPSB7CiAgICAgICAgICAgICJpZCI6IHN0cih1dWlkLnV1aWQ0KCkpLAogICAgICAgICAgICAidGltZSI6IGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpLmlzb2Zvcm1hdCgpLAogICAgICAgICAgICAic3ltYm9sIjogc3ltYm9sLAogICAgICAgICAgICAic2lkZSI6ICJidXkiLAogICAgICAgICAgICAic3RyYXRlZ3kiOiBzdHJhdGVneSwKICAgICAgICAgICAgImVudHJ5X3ByaWNlIjogZXhlY19wcmljZSwKICAgICAgICAgICAgInF0eSI6IHF0eSwKICAgICAgICAgICAgInVzZWRfdXNkIjogdXNlZCwKICAgICAgICAgICAgInN0YXR1cyI6ICJvcGVuIiwKICAgICAgICAgICAgInBubCI6IDAuMCwKICAgICAgICAgICAgInNsIjogc2wsCiAgICAgICAgICAgICJ0cCI6IHRwLAogICAgICAgICAgICAiZXhpdF9wcmljZSI6IDAuMCwKICAgICAgICAgICAgImN1cnJlbnRfcHJpY2UiOiBwcmljZSwKICAgICAgICAgICAgInVucmVhbGl6ZWRfcG5sIjogMC4wLAogICAgICAgICAgICAiZmVlc191c2QiOiBmZWVzLAogICAgICAgICAgICAiaGlnaGVzdF9wcmljZSI6IHByaWNlLAogICAgICAgICAgICAidHJhaWxfYWN0aXZlIjogRmFsc2UsCiAgICAgICAgICAgICJ0cmFpbF9zbCI6IDAuMAogICAgICAgIH0KICAgICAgICBhd2FpdCBkYi5hZGRfdHJhZGUodHJhZGUpCiAgICAKICAgIGF3YWl0IHJlZ2lzdGVyX3RyYWRlX29wZW4oc3ltYm9sLCBzdHJhdGVneSkKICAgIGxvZ2dlci5pbmZvKGYiW0JVWV0ge3N5bWJvbH0gQCB7ZXhlY19wcmljZX0iKQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KIyBTRUxMIExPR0lDCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCmFzeW5jIGRlZiBleGVjdXRlX3NlbGwodHJhZGVfaWQsIHBjdD0xMDAuMCwgcmVhc29uPSJtYW51YWwiKToKICAgIHRyeToKICAgICAgICB0cmFkZSA9IGF3YWl0IGRiLmdldF90cmFkZSh0cmFkZV9pZCkKICAgICAgICBpZiBub3QgdHJhZGUgb3IgdHJhZGVbJ3N0YXR1cyddICE9ICdvcGVuJzogcmV0dXJuCgogICAgICAgIHRpY2tlciA9IGF3YWl0IHNhZmVfZmV0Y2hfdGlja2VyKHRyYWRlWydzeW1ib2wnXSkKICAgICAgICBpZiBub3QgdGlja2VyOiByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgcHJpY2UgPSBudW0odGlja2VyWyJsYXN0Il0pCiAgICAgICAgCiAgICAgICAgc2VsbF9xdHkgPSBzYWZlKHRyYWRlWydxdHknXSAqIHBjdCAvIDEwMCkKICAgICAgICBpZiBzZWxsX3F0eSA8PSAwOiByZXR1cm4KCiAgICAgICAgIyBFeGVjdXRpb24KICAgICAgICBpZiBUUkFERV9NT0RFID09ICJsaXZlIjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYmFsID0gYXdhaXQgZXhfbGl2ZS5mZXRjaF9iYWxhbmNlKCkKICAgICAgICAgICAgICAgIGJhc2UgPSB0cmFkZVsnc3ltYm9sJ10uc3BsaXQoJy8nKVswXQogICAgICAgICAgICAgICAgYXZhaWxhYmxlID0gYmFsLmdldChiYXNlLCB7fSkuZ2V0KCdmcmVlJywgMCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBbSEFSREVOSU5HXSBDaGVjayBmb3IgUGhhbnRvbSBTZWxsCiAgICAgICAgICAgICAgICAjIElmIHdlIGFyZSB0cnlpbmcgdG8gc2VsbCBidXQgZXhjaGFuZ2Ugc2F5cyB3ZSBoYXZlIDAsIAogICAgICAgICAgICAgICAgIyB0aGVuIHRoaXMgREIgZW50cnkgaXMgc3RhbGUvcGhhbnRvbS4gQ2xvc2UgaXQgaW1tZWRpYXRlbHkuCiAgICAgICAgICAgICAgICBpZiBhdmFpbGFibGUgPD0gMWUtODoKICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYi4p2MIFtQSEFOVE9NIFNFTEwgREVURUNURURdIHt0cmFkZVsnc3ltYm9sJ119OiBXYWxsZXQgRW1wdHkgKHthdmFpbGFibGV9KS4gTWFya2luZyBDbG9zZWQuIikKICAgICAgICAgICAgICAgICAgICAgYXdhaXQgZGIudXBkYXRlX3RyYWRlKHRyYWRlX2lkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiY2xvc2VkIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICJleGl0X3RpbWUiOiBkYXRldGltZS5ub3codGltZXpvbmUudXRjKS5pc29mb3JtYXQoKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICJwbmwiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZXhpdF9wcmljZSI6IHByaWNlCiAgICAgICAgICAgICAgICAgICAgIH0pIAogICAgICAgICAgICAgICAgICAgICAjIFtGSVhdIFJlZ2lzdHJ5IHVwZGF0ZSBmb3IgY29uc2lzdGVuY3kKICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmVnaXN0ZXJfdHJhZGVfY2xvc2UoMC4wLCB0cmFkZVsnc3ltYm9sJ10pCiAgICAgICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgICAgICMgRHVzdCBTYWZldHkKICAgICAgICAgICAgICAgIGlmIGF2YWlsYWJsZSA8IHNlbGxfcXR5OgogICAgICAgICAgICAgICAgICAgIHNlbGxfcXR5ID0gYXZhaWxhYmxlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTWluIE5vdGlvbiBTYWZldHkKICAgICAgICAgICAgICAgIGlmIChzZWxsX3F0eSAqIHByaWNlKSA8IDUuMCBhbmQgcGN0IDwgOTk6CiAgICAgICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgICAgICMgUHJlY2lzaW9uCiAgICAgICAgICAgICAgICBzZWxsX3F0eV9wcmVjID0gbnVtKGV4X2xpdmUuYW1vdW50X3RvX3ByZWNpc2lvbih0cmFkZVsnc3ltYm9sJ10sIHNlbGxfcXR5KSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgb3JkZXIgPSBhd2FpdCBleF9saXZlLmNyZWF0ZV9tYXJrZXRfc2VsbF9vcmRlcih0cmFkZVsnc3ltYm9sJ10sIHNlbGxfcXR5X3ByZWMpCiAgICAgICAgICAgICAgICAjIFJvYnVzdCBwcmljZSBmZXRjaGluZwogICAgICAgICAgICAgICAgZXhlY19wcmljZSA9IG51bShvcmRlci5nZXQoImF2ZXJhZ2UiKSBvciBvcmRlci5nZXQoInByaWNlIikgb3IgcHJpY2UpCiAgICAgICAgICAgICAgICBxdHlfc29sZCA9IG51bShvcmRlci5nZXQoImZpbGxlZCIpIG9yIHNlbGxfcXR5X3ByZWMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG51bShvcmRlci5nZXQoImZpbGxlZCIsIDApKSA8PSAwOgogICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIG9yZGVyID0gYXdhaXQgZXhfbGl2ZS5mZXRjaF9vcmRlcihvcmRlclsnaWQnXSwgdHJhZGVbJ3N5bWJvbCddKQogICAgICAgICAgICAgICAgICAgICAgICBleGVjX3ByaWNlID0gbnVtKG9yZGVyLmdldCgiYXZlcmFnZSIpIG9yIG9yZGVyLmdldCgicHJpY2UiKSBvciBwcmljZSkKICAgICAgICAgICAgICAgICAgICAgICAgcXR5X3NvbGQgPSBudW0ob3JkZXIuZ2V0KCJmaWxsZWQiKSBvciBzZWxsX3F0eV9wcmVjKQogICAgICAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2VsbF9xdHkgPSBxdHlfc29sZCAjIFVzZSBhY3R1YWwgZmlsbGVkIHF0eSBpZiBwb3NzaWJsZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFtTWU5DXSBGZXRjaCByZWFsIGZlZXMgZnJvbSBCaW5hbmNlCiAgICAgICAgICAgICAgICBmZWVfb2JqID0gb3JkZXIuZ2V0KCdmZWUnKQogICAgICAgICAgICAgICAgaWYgZmVlX29iaiBhbmQgZmVlX29iai5nZXQoJ2Nvc3QnKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBmZWVzID0gbnVtKGZlZV9vYmpbJ2Nvc3QnXSkKICAgICAgICAgICAgICAgICAgICAjIEZlZSBvbiBzZWxsIGlzIHVzdWFsbHkgVVNEVAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBmZWVzID0gc2FmZShleGVjX3ByaWNlICogc2VsbF9xdHkgKiBDT01NSVNTSU9OX1BDVCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZ2xvYmFsIGNvbnNlY3V0aXZlX2FwaV9lcnJvcnMsIHBhdXNlX3VudGlsX3RzCiAgICAgICAgICAgICAgICBjb25zZWN1dGl2ZV9hcGlfZXJyb3JzICs9IDEKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIuKdjCBbU0VMTCBGQUlMXSB7dHJhZGVbJ3N5bWJvbCddfToge2V9IChDb25zZWN1dGl2ZToge2NvbnNlY3V0aXZlX2FwaV9lcnJvcnN9KSIpCiAgICAgICAgICAgICAgICBpZiBjb25zZWN1dGl2ZV9hcGlfZXJyb3JzID49IDU6CiAgICAgICAgICAgICAgICAgICAgcGF1c2VfdW50aWxfdHMgPSBkYXRldGltZS5ub3coKS50aW1lc3RhbXAoKSArICgxNSAqIDYwKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5jcml0aWNhbCgi8J+aqCBbQ1JJVElDQUxdIDUrIENvbnNlY3V0aXZlIEFQSSBFcnJvcnMuIFBhdXNpbmcgZm9yIDE1IG1pbnMuIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGV4ZWNfcHJpY2UgPSBwcmljZQogICAgICAgICAgICBmZWVzID0gc2FmZShleGVjX3ByaWNlICogc2VsbF9xdHkgKiBDT01NSVNTSU9OX1BDVCkKCiAgICAgICAgcG5sID0gc2FmZSgoZXhlY19wcmljZSAtIHRyYWRlWydlbnRyeV9wcmljZSddKSAqIHNlbGxfcXR5IC0gZmVlcykKICAgICAgICAKICAgICAgICByZW1haW5pbmcgPSBzYWZlKHRyYWRlWydxdHknXSAtIHNlbGxfcXR5KQogICAgICAgIAogICAgICAgICMgQ2xlYW4gRHVzdAogICAgICAgIGlmIHJlbWFpbmluZyAqIHByaWNlIDwgMi4wIG9yIHBjdCA+PSA5OS4wOgogICAgICAgICAgICBhd2FpdCBkYi51cGRhdGVfdHJhZGUodHJhZGVfaWQsIHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiY2xvc2VkIiwKICAgICAgICAgICAgICAgICJxdHkiOiAwLAogICAgICAgICAgICAgICAgIyAidXNlZF91c2QiOiAwLCAjIFtGSVhdIFByZXNlcnZlIHVzZWRfdXNkIGZvciBoaXN0b3J5L3N0YXRzCiAgICAgICAgICAgICAgICAiZXhpdF9wcmljZSI6IGV4ZWNfcHJpY2UsCiAgICAgICAgICAgICAgICAicG5sIjogc2FmZSh0cmFkZVsncG5sJ10gKyBwbmwpLAogICAgICAgICAgICAgICAgImZlZXNfdXNkIjogc2FmZSh0cmFkZVsnZmVlc191c2QnXSArIGZlZXMpLAogICAgICAgICAgICAgICAgImV4aXRfdGltZSI6IGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpLmlzb2Zvcm1hdCgpCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIGF3YWl0IHJlZ2lzdGVyX3RyYWRlX2Nsb3NlKHBubCwgdHJhZGVbJ3N5bWJvbCddKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfkrAgW1RSQURFIENMT1NFRF0ge3RyYWRlWydzeW1ib2wnXX0gfCBQbkw6IHtwbmw6LjRmfSB8IFJlYXNvbjoge3JlYXNvbn0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF3YWl0IGRiLnVwZGF0ZV90cmFkZSh0cmFkZV9pZCwgewogICAgICAgICAgICAgICAgInF0eSI6IHJlbWFpbmluZywKICAgICAgICAgICAgICAgICJ1c2VkX3VzZCI6IHNhZmUodHJhZGVbJ3VzZWRfdXNkJ10gKiAocmVtYWluaW5nIC8gdHJhZGVbJ3F0eSddKSksCiAgICAgICAgICAgICAgICAicG5sIjogc2FmZSh0cmFkZVsncG5sJ10gKyBwbmwpLAogICAgICAgICAgICAgICAgImZlZXNfdXNkIjogc2FmZSh0cmFkZVsnZmVlc191c2QnXSArIGZlZXMpCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+TiSBbU0VMTCBQQVJUSUFMXSB7dHJhZGVbJ3N5bWJvbCddfSBQbkw6IHtwbmw6LjRmfSIpCiAgICAgICAgICAgIAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ2dlci5leGNlcHRpb24oZiJbRVhFQ1VURSBTRUxMIEVSUk9SXSB7dHJhZGVfaWR9IikKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiMgTE9PUFMKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KYXN5bmMgZGVmIHdhdGNoZXJfbG9vcCgpOgogICAgbG9nZ2VyLmluZm8oIldhdGNoZXIgc3RhcnRlZCIpCiAgICB3aGlsZSBUcnVlOgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBbSEFSREVOSU5HXSBEYWlseSBDaXJjdWl0IEJyZWFrZXIgLSBSRU1PVkVECiAgICAgICAgICAgIAogICAgICAgICAgICB0cmFkZXMgPSBhd2FpdCBkYi5nZXRfb3Blbl90cmFkZXMoKQogICAgICAgICAgICBpZiBub3QgdHJhZGVzOgogICAgICAgICAgICAgICAgYXdhaXQgYXN5bmNpby5zbGVlcChXQVRDSEVSX0lOVEVSVkFMKQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgW0hBUkRFTklOR10gV2F0Y2hlciBTYWZldHkgQ2xlYW51cAogICAgICAgICAgICAjIElmIHdlIGZpbmQgYSB0cmFkZSBvcGVuIGluIERCIGJ1dCBlbXB0eSBpbiBXYWxsZXQsIGNsb3NlIGl0LgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBiYWwgPSBhd2FpdCBleF9saXZlLmZldGNoX2JhbGFuY2UoKQogICAgICAgICAgICAgICAgdG90YWwgPSBiYWwuZ2V0KCd0b3RhbCcsIHt9KQogICAgICAgICAgICAgICAgZm9yIHQgaW4gdHJhZGVzOgogICAgICAgICAgICAgICAgICAgIGNvaW4gPSB0WydzeW1ib2wnXS5zcGxpdCgnLycpWzBdCiAgICAgICAgICAgICAgICAgICAgcmVhbF9xdHkgPSB0b3RhbC5nZXQoY29pbiwgMC4wKQogICAgICAgICAgICAgICAgICAgIGlmIHJlYWxfcXR5IDw9IDFlLTggb3IgcmVhbF9xdHkgPCAodFsncXR5J10gKiAwLjA1KToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiLwn6e5IFtXQVRDSEVSIENMRUFOVVBdIHt0WydzeW1ib2wnXX0gZm91bmQgZW1wdHkvZHVzdCAoe3JlYWxfcXR5fSkuIEF1dG8tY2xvc2luZy4iKQogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBkYi51cGRhdGVfdHJhZGUodFsnaWQnXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJjbG9zZWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4aXRfdGltZSI6IGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpLmlzb2Zvcm1hdCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInBubCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXhpdF9wcmljZSI6IDAKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcmVnaXN0ZXJfdHJhZGVfY2xvc2UoMC4wLCB0WydzeW1ib2wnXSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiW1dBVENIRVIgQ0xFQU5VUCBFUlJPUl0ge2V9IikKCiAgICAgICAgICAgIGZvciB0IGluIHRyYWRlczoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzeW1ib2wgPSB0WydzeW1ib2wnXQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQ2hlY2sgaWYgaXQgd2FzIGp1c3QgY2xvc2VkIGJ5IGNsZWFudXAKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3RyYWRlX2NoZWNrID0gYXdhaXQgZGIuZ2V0X3RyYWRlKHRbJ2lkJ10pCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfdHJhZGVfY2hlY2sgb3IgY3VycmVudF90cmFkZV9jaGVja1snc3RhdHVzJ10gIT0gJ29wZW4nOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICAgICAjIFtIQVJERU5JTkddIE1heCBIb2xkIFRpbWUgRW5mb3JjZW1lbnQKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0X3N0ciA9IHRbJ3RpbWUnXS5yZXBsYWNlKCdaJywgJyswMDowMCcpCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0X3RpbWUgPSBkYXRldGltZS5mcm9taXNvZm9ybWF0KHN0YXJ0X3N0cikKICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb25fc2VjID0gKGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpIC0gc3RhcnRfdGltZSkudG90YWxfc2Vjb25kcygpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGR1cmF0aW9uX3NlYyA+IE1BWF9IT0xEX1NFQ09ORFM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKPsyBbVElNRSBFWElUXSB7c3ltYm9sfSBoZWxkIGZvciB7aW50KGR1cmF0aW9uX3NlYyl9cy4gQ2xvc2luZy4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgZXhlY3V0ZV9zZWxsKHRbJ2lkJ10sIDEwMCwgInRpbWVfZXhpdCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogcGFzcwoKICAgICAgICAgICAgICAgICAgICB0aWNrZXIgPSBhd2FpdCBzYWZlX2ZldGNoX3RpY2tlcihzeW1ib2wpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHRpY2tlcjogY29udGludWUKICAgICAgICAgICAgICAgICAgICBwcmljZSA9IG51bSh0aWNrZXJbJ2xhc3QnXSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB1bnJlYWwgPSAocHJpY2UgLSB0WydlbnRyeV9wcmljZSddKSAqIHRbJ3F0eSddCiAgICAgICAgICAgICAgICAgICAgaGlnaGVzdCA9IG1heCh0WydoaWdoZXN0X3ByaWNlJ10sIHByaWNlKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZXMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICJjdXJyZW50X3ByaWNlIjogcHJpY2UsCiAgICAgICAgICAgICAgICAgICAgICAgICJ1bnJlYWxpemVkX3BubCI6IHNhZmUodW5yZWFsKSwKICAgICAgICAgICAgICAgICAgICAgICAgImhpZ2hlc3RfcHJpY2UiOiBoaWdoZXN0CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgICAgICAgICAgICAjIFNUT1AgTE9TUyAmIFRBS0UgUFJPRklUIENIRUNLUyAoVU5JVkVSU0FMKQogICAgICAgICAgICAgICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgICAgICAgICAgICB0X3NsID0gdC5nZXQoJ3NsJywgMC4wKQogICAgICAgICAgICAgICAgICAgIHRfdHAgPSB0LmdldCgndHAnLCAwLjApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgdF9zbCA+IDAgYW5kIHByaWNlIDw9IHRfc2w6CiAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfm5EgW1NMIEhJVF0ge3N5bWJvbH0gQCB7cHJpY2V9IChTTDoge3Rfc2x9KSIpCiAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBkYi51cGRhdGVfdHJhZGUodFsnaWQnXSwgdXBkYXRlcykKICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGV4ZWN1dGVfc2VsbCh0WydpZCddLCAxMDAsICJzdG9wX2xvc3MiKQogICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiB0X3RwID4gMCBhbmQgcHJpY2UgPj0gdF90cDoKICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+OryBbVFAgSElUXSB7c3ltYm9sfSBAIHtwcmljZX0gKFRQOiB7dF90cH0pIikKICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGRiLnVwZGF0ZV90cmFkZSh0WydpZCddLCB1cGRhdGVzKQogICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgZXhlY3V0ZV9zZWxsKHRbJ2lkJ10sIDEwMCwgInRha2VfcHJvZml0IikKICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgICAgICMgW1JVTEVdIE5vIHRyYWlsaW5nIHN0b3Agb3IgcGFydGlhbCBleGl0cy4KICAgICAgICAgICAgICAgICAgICAjIFNpbXBsZSB1cGRhdGUgb2YgUG5MIHN0YXRzLgogICAgICAgICAgICAgICAgICAgIGF3YWl0IGRiLnVwZGF0ZV90cmFkZSh0WydpZCddLCB1cGRhdGVzKQoKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJbV0FUQ0hFUiBFUlJPUl0ge3RbJ3N5bWJvbCddfToge2V9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGF3YWl0IGFzeW5jaW8uc2xlZXAoV0FUQ0hFUl9JTlRFUlZBTCkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKCJXYXRjaGVyIGVycm9yIikKICAgICAgICAKICAgICAgICBhd2FpdCBhc3luY2lvLnNsZWVwKFdBVENIRVJfSU5URVJWQUwpCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIEJBQ0tHUk9VTkQgTE9PUFMKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIFBBUkFMTEVMIFNDQU5ORVJTCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCnNjYW5fc2VtID0gYXN5bmNpby5TZW1hcGhvcmUoMTApICMgTGltaXQgY29uY3VycmVudCByZXF1ZXN0cwoKYXN5bmMgZGVmIHNjYW5fc21jX3RhcmdldChzeW1ib2wsIGV4LCBhY3RpdmVfc3RyYXRlZ2llcyk6CiAgICAiIiIKICAgIFJldHVybnM6IChzeW1ib2wsIHNjYW5uZXJfaXRlbXMsIGRpYWdub3N0aWMsIHNob3VsZF9idXksIGJ1bGxpc2hfdHJlbmRfZm91bmQpCiAgICAiIiIKICAgIGFzeW5jIHdpdGggc2Nhbl9zZW06CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIDEuIFtDT05URVhUXSBGZXRjaCAxaCBmb3IgRGlyZWN0aW9uYWwgQmlhcyAoSGlnaGVyIFRGKQogICAgICAgICAgICBvaGxjdl9jb250ZXh0ID0gYXdhaXQgZXguZmV0Y2hfb2hsY3Yoc3ltYm9sLCAnMWgnLCBsaW1pdD0xMDApCiAgICAgICAgICAgIGlmIG5vdCBvaGxjdl9jb250ZXh0IG9yIGxlbihvaGxjdl9jb250ZXh0KSA8IDUwOiByZXR1cm4gKHN5bWJvbCwgTm9uZSwgTm9uZSwgRmFsc2UsIEZhbHNlKQogICAgICAgICAgICAKICAgICAgICAgICAgZGZfY29udGV4dCA9IHBkLkRhdGFGcmFtZShvaGxjdl9jb250ZXh0LCBjb2x1bW5zPVsndHMnLCAnb3BlbicsICdoaWdoJywgJ2xvdycsICdjbG9zZScsICd2b2wnXSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgW1NUUkFURUdZXSBDYWxjdWxhdGUgU3ltYm9sIDI0SCBDaGFuZ2UgZm9yIENvbnRleHQKICAgICAgICAgICAgICMgSGVscGVyIHRvIGNhbGMgMjRoIGNoYW5nZSBBcHByb3ggKDI0IGNhbmRsZXMpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG9wZW5fMjRoID0gZGZfY29udGV4dFsnb3BlbiddLmlsb2NbLTI1XSBpZiBsZW4oZGZfY29udGV4dCkgPj0gMjUgZWxzZSBkZl9jb250ZXh0WydvcGVuJ10uaWxvY1swXQogICAgICAgICAgICAgICAgY3Vycl9jbG9zZSA9IGRmX2NvbnRleHRbJ2Nsb3NlJ10uaWxvY1stMV0KICAgICAgICAgICAgICAgIHN5bWJvbF9wY3RfY2hhbmdlID0gKChjdXJyX2Nsb3NlIC0gb3Blbl8yNGgpIC8gb3Blbl8yNGgpICogMTAwCiAgICAgICAgICAgIGV4Y2VwdDogc3ltYm9sX3BjdF9jaGFuZ2UgPSAwLjAKCiAgICAgICAgICAgICMgQ29udGV4dCBBbmFseXNpcwogICAgICAgICAgICB0cmVuZF9idWxsaXNoID0gVHJ1ZSAKCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDFoIFJTSSAoUkVNT1ZFRCkKICAgICAgICAgICAgIyBbVVNFUiBSRVFVRVNUXSBSU0kgbG9naWMgY29tcGxldGVseSByZW1vdmVkLgogICAgICAgICAgICAKICAgICAgICAgICAgY29udGV4dCA9IHsKICAgICAgICAgICAgICAgICJ0cmVuZF9idWxsaXNoIjogdHJlbmRfYnVsbGlzaCwKICAgICAgICAgICAgICAgICJvaGxjdl8xaCI6IG9obGN2X2NvbnRleHQsICMgUGFzcyByYXcgZGF0YSBmb3IgSFRGIE9CIGFuYWx5c2lzCiAgICAgICAgICAgICAgICAic3ltYm9sX3BjdF9jaGFuZ2UiOiBzeW1ib2xfcGN0X2NoYW5nZSwgIyBbTkVXXQogICAgICAgICAgICAgICAgImJ0Y19wY3RfY2hhbmdlIjogYWN0aXZlX3N0cmF0ZWdpZXMuZ2V0KCJidGNfcGN0IiwgMC4wKSBpZiBpc2luc3RhbmNlKGFjdGl2ZV9zdHJhdGVnaWVzLCBkaWN0KSBlbHNlIDAuMCAjIEhhY2t5IHBhc3MKICAgICAgICAgICAgfQoKICAgICAgICAgICAgIyAyLiBbRU5UUlldIEZldGNoIDE1bSBmb3IgRW50cnkgKFN0cm9uZyBUcmVuZCBTdHJhdGVneSkKICAgICAgICAgICAgb2hsY3ZfZW50cnkgPSBhd2FpdCBleC5mZXRjaF9vaGxjdihzeW1ib2wsICcxNW0nLCBsaW1pdD0xMDApCiAgICAgICAgICAgIGlmIG5vdCBvaGxjdl9lbnRyeSBvciBsZW4ob2hsY3ZfZW50cnkpIDwgNjA6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIltERUJVR10ge3N5bWJvbH0gbm90IGVub3VnaCAxNW0gZGF0YToge2xlbihvaGxjdl9lbnRyeSkgaWYgb2hsY3ZfZW50cnkgZWxzZSAwfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gKHN5bWJvbCwgTm9uZSwgTm9uZSwgRmFsc2UsIEZhbHNlKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAzLiBDaGVjayBTaWduYWwgd2l0aCBNdWx0aS1UaW1lZnJhbWUgTG9naWMKICAgICAgICAgICAgaXNfdmFsaWRfc2lnbmFsLCBkaWFnbm9zdGljID0gU3RyYXRlZ3lNYW5hZ2VyLmNoZWNrX3NpZ25hbChzeW1ib2wsIG9obGN2X2VudHJ5LCBjb250ZXh0KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBFbnJpY2ggZGlhZ25vc3RpYyB3aXRoIENvbnRleHQKICAgICAgICAgICAgaWYgZGlhZ25vc3RpYzoKICAgICAgICAgICAgICAgIGRpYWdub3N0aWNbJ3RyZW5kXzFoJ10gPSAiQnVsbGlzaCIgIyBBbHdheXMgVHJ1ZSBub3cKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IFNjYW5uZXIgRGF0YSAoVmlzdWFscykKICAgICAgICAgICAgIyBQYXNzIENPTlRFWFQgc28gd2UgY2FuIHZpc3VhbGl6ZSB0aGUgSFRGIE9CIChFbnRyeSBab25lKQogICAgICAgICAgICBzY2FubmVyX2RhdGEgPSBTdHJhdGVneU1hbmFnZXIuZ2V0X3NjYW5uZXJfZGF0YShzeW1ib2wsIG9obGN2X2VudHJ5LCBjb250ZXh0KQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc2Nhbm5lcl9kYXRhOgogICAgICAgICAgICAgICAgIyBbVklTVUFMU10gQ29tcHV0ZSBWb2xhdGlsaXR5IGZvciBEYXNoYm9hcmQKICAgICAgICAgICAgICAgIGRmX2VudHJ5ID0gcGQuRGF0YUZyYW1lKG9obGN2X2VudHJ5LCBjb2x1bW5zPVsndHMnLCAnb3BlbicsICdoaWdoJywgJ2xvdycsICdjbG9zZScsICd2b2wnXSkKICAgICAgICAgICAgICAgIHZfb2ssIHZfbXNnID0gY2hlY2tfdm9sYXRpbGl0eV9vayhkZl9lbnRyeSwgJzE1bScpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBpdGVtIGluIHNjYW5uZXJfZGF0YToKICAgICAgICAgICAgICAgICAgICBpdGVtWyd0cmVuZCddID0gIkJ1bGxpc2giIAogICAgICAgICAgICAgICAgICAgIGl0ZW1bJ3ZvbF9vayddID0gdl9vawogICAgICAgICAgICAgICAgICAgIGl0ZW1bJ3ZvbF9tc2cnXSA9IHZfbXNnCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gKHN5bWJvbCwgc2Nhbm5lcl9kYXRhLCBkaWFnbm9zdGljLCBpc192YWxpZF9zaWduYWwsIHRyZW5kX2J1bGxpc2gpCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiRXJyb3Igc2Nhbm5pbmcge3N5bWJvbH06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAoc3ltYm9sLCBOb25lLCBOb25lLCBGYWxzZSwgRmFsc2UpCgoKYXN5bmMgZGVmIHN0cmF0ZWd5X2xvb3AoKToKICAgIGxvZ2dlci5pbmZvKCJTdHJhdGVneSBMb29wIFN0YXJ0ZWQgKFBhcmFsbGVsaXplZCBWMikuLi4iKQogICAgaWdub3JlZCA9IFsiVVNEQyIsICJVU0RQIiwgIkZEVVNEIiwgIlRVU0QiLCAiRVVSIiwgIkdCUCIsICJEQUkiLCAKICAgICAgICAgICAgICAgIlNBUElFTiIsICJEQVRBIiwgIkZUVCIsICJCVFRDIiwgIkdVTiJdIAogICAgZ2xvYmFsIHNtY19zY2FubmVyX2NhY2hlCiAgICBnbG9iYWwgbWFya2V0X3RyZW5kX3Njb3JlLCBtYXJrZXRfdHJlbmRfbGFiZWwKICAgIAogICAgd2hpbGUgVHJ1ZToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0YXJ0X3RzID0gZGF0ZXRpbWUubm93KCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJbREVCVUddIExvb3AgQ3ljbGUgU3RhcnQge3N0YXJ0X3RzfSIpCiAgICAgICAgICAgICMgW1NBRkVUWV0gUGVyaW9kaWMgU3luYwogICAgICAgICAgICBhd2FpdCBzeW5jX3BvcnRmb2xpb193aXRoX2V4Y2hhbmdlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgW1JFU0VUXSBDaGVjayBmb3IgbmV3IGRheSBpbW1lZGlhdGVseQogICAgICAgICAgICBhd2FpdCBkYWlseV9yZXNldF9pZl9uZWVkZWQoKQogICAgICAgICAgICAKICAgICAgICAgICAgc3RhdGUgPSBhd2FpdCBnZXRfYXBwX3N0YXRlKCkKICAgICAgICAgICAgaWYgbm90IHN0YXRlLmdldCgiYXV0b190cmFkaW5nIikgb3Igc3RhdGUuZ2V0KCJraWxsX3N3aXRjaCIpOgogICAgICAgICAgICAgICAgYXdhaXQgYXN5bmNpby5zbGVlcCg1KQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFtTQUZFVFldIERhaWx5IExvc3MgQ291bnQgTGltaXQgLSBSRU1PVkVECiAgICAgICAgICAgIAogICAgICAgICAgICAjIFtPUFRJTUlaQVRJT05dIFRpbWUgRmlsdGVyOiBBdm9pZCBMYXRlIE5ZIChEZWF0aCBab25lKQogICAgICAgICAgICAjIDE3OjAwIC0gMjA6MDAgVVRDIChVc2VyIHN0YXRzIHNob3cgLTMzJSBXUiAvIE5lZ2F0aXZlIFBuTCBoZXJlKQogICAgICAgICAgICAjIFtVUERBVEVdIERpc2FibGVkIHVwb24gdXNlciByZXF1ZXN0LiBTdHJpY3QgbG9naWMgaGFuZGxlcyBxdWFsaXR5IG5vdy4KICAgICAgICAgICAgIyBub3dfdXRjID0gZGF0ZXRpbWUubm93KHRpbWV6b25lLnV0YykKICAgICAgICAgICAgIyBpZiAxNyA8PSBub3dfdXRjLmhvdXIgPCAyMDoKICAgICAgICAgICAgIyAgICAgIGxvZ2dlci53YXJuaW5nKGYi8J+SpCBbVElNRSBGSUxURVJdIExhdGUgTlkgU2Vzc2lvbiAoe25vd191dGMuc3RyZnRpbWUoJyVIOiVNJyl9IFVUQykuIFNsZWVwaW5nIHVudGlsIDIwOjAwIFVUQy4iKQogICAgICAgICAgICAjICAgICAgc21jX3NjYW5uZXJfY2FjaGUgPSBbXQogICAgICAgICAgICAjICAgICAgYXdhaXQgYXN5bmNpby5zbGVlcCg2MCkKICAgICAgICAgICAgIyAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFtTVFJBVEVHWSBSRVNFVF0gMS4gTWFya2V0IFJlZ2ltZSAtIFJFTU9WRUQgKFVzZXIgUmVxdWVzdCkKICAgICAgICAgICAgIyBXZSBhc3N1bWUgQnVsbGlzaCB1bmxlc3MgVGltZSBGaWx0ZXIgaGl0cy4KICAgICAgICAgICAgbWFya2V0X3RyZW5kX2xhYmVsID0gIkJ1bGxpc2giCiAgICAgICAgICAgIG1hcmtldF90cmVuZF9zY29yZSA9IDEwMAogICAgICAgICAgICAKICAgICAgICAgICAgIyAxLiBGZXRjaCBhbGwgdGlja2VycwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB0aWNrZXJzID0gYXdhaXQgZXhfbGl2ZS5mZXRjaF90aWNrZXJzKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiW1NDQU4gRVJST1JdIEZldGNoIHRpY2tlcnMgZmFpbGVkOiB7ZX0iKQogICAgICAgICAgICAgICAgYXdhaXQgYXN5bmNpby5zbGVlcCgxMCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAjIDIuIEZpbHRlciBhbmQgU29ydAogICAgICAgICAgICBhbGxfY2FuZGlkYXRlcyA9IFtdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFtTVFJBVEVHWV0gRmV0Y2ggQlRDICUgQ2hhbmdlIGZvciBSZWxhdGl2ZSBTdHJlbmd0aCBDb21wYXJpc29uCiAgICAgICAgICAgIGJ0Y190aWNrZXIgPSBhd2FpdCBzYWZlX2ZldGNoX3RpY2tlcigiQlRDL1VTRFQiKQogICAgICAgICAgICBidGNfcGN0ID0gZmxvYXQoYnRjX3RpY2tlclsncGVyY2VudGFnZSddIG9yIDApIGlmIGJ0Y190aWNrZXIgZWxzZSAwCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgcywgdCBpbiB0aWNrZXJzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiAiL1VTRFQiIGluIHM6CiAgICAgICAgICAgICAgICAgICAgYmFzZSA9IHMuc3BsaXQoJy8nKVswXQogICAgICAgICAgICAgICAgICAgIGlmIGJhc2Ugbm90IGluIGlnbm9yZWQgYW5kIHMgIT0gJ0JUQy9VU0RUJzoKICAgICAgICAgICAgICAgICAgICAgICAgIyBbU1RSQVRFR1ldIFJlbGF0aXZlIFN0cmVuZ3RoIEZpbHRlciAoMjRoIENoYW5nZSkKICAgICAgICAgICAgICAgICAgICAgICAgIyBQaWNrIGFzc2V0cyBvdXRwZXJmb3JtaW5nIEJUQyBvdmVyIHRoZSBsYXN0IDI0aAogICAgICAgICAgICAgICAgICAgICAgICBhc3NldF9wY3QgPSBmbG9hdCh0WydwZXJjZW50YWdlJ10gb3IgMCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYXNzZXRfcGN0ID4gYnRjX3BjdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxfY2FuZGlkYXRlcy5hcHBlbmQodCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGFsbF9jYW5kaWRhdGVzLnNvcnQoa2V5PWxhbWJkYSB4OiBmbG9hdCh4WydwZXJjZW50YWdlJ10gb3IgMCksIHJldmVyc2U9VHJ1ZSkKICAgICAgICAgICAgdG9wX2dhaW5lcnMgPSBbdFsnc3ltYm9sJ10gZm9yIHQgaW4gYWxsX2NhbmRpZGF0ZXNbOjM1XV0gIyBGb2N1cyBvbiBUb3AgMzUgTGVhZGVycyAKICAgICAgICAgICAgCiAgICAgICAgICAgIG9wZW5fdHJhZGVzID0gYXdhaXQgZGIuZ2V0X29wZW5fdHJhZGVzKCkKICAgICAgICAgICAgYWN0aXZlX3N0cmF0cyA9IFt0WydzdHJhdGVneSddIGZvciB0IGluIG9wZW5fdHJhZGVzXSAjIE5vdCBzdHJpY3RseSBuZWVkZWQgaW5zaWRlIHNjYW4sIGJ1dCBnb29kIGZvciBjb250ZXh0IGlmIG5lZWRlZCBsYXRlcgogICAgICAgICAgICAKICAgICAgICAgICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgICAgIyBNQVJLRVQgSU5URUxMSUdFTkNFIChBbGlnbmVkIHdpdGggVHJhZGluZyBMb2dpYykKICAgICAgICAgICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgICAgIyBbRklYXSBGb3JjZSBCdWxsaXNoIChVc2VyIHJlbW92ZWQgZmlsdGVyKQogICAgICAgICAgICBidGNfcmVnaW1lID0gImJ1bGxpc2giCiAgICAgICAgICAgIGJ0Y19tdWx0aXBsaWVyID0gMS4wCiAgICAgICAgICAgIAogICAgICAgICAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgICAgICAjIFBBUkFMTEVMIEVYRUNVVElPTjogU01DCiAgICAgICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFtSVUxFXSBHbG9iYWwgTWFya2V0IENvbmRpdGlvbjogQlRDIDFIIENhbmRsZSBSYW5nZSA+IDIlCiAgICAgICAgICAgICMgSWYgKEhpZ2ggLSBMb3cpIC8gT3BlbiA+IDAuMDIsIEJMT0NLIEFMTCBUUkFERVMKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIGJ0Y19jYW5kbGVzID0gYXdhaXQgZXhfbGl2ZS5mZXRjaF9vaGxjdigiQlRDL1VTRFQiLCAiMWgiLCBsaW1pdD01KQogICAgICAgICAgICAgICAgIGlmIGJ0Y19jYW5kbGVzOgogICAgICAgICAgICAgICAgICAgICBsYXN0X2J0YyA9IGJ0Y19jYW5kbGVzWy0xXSAjIFt0cywgbywgaCwgbCwgYywgdl0KICAgICAgICAgICAgICAgICAgICAgIyBDaGVjayByYW5nZQogICAgICAgICAgICAgICAgICAgICBybmcgPSAobGFzdF9idGNbMl0gLSBsYXN0X2J0Y1szXSkgLyBsYXN0X2J0Y1sxXQogICAgICAgICAgICAgICAgICAgICBpZiBybmcgPiAwLjAyOgogICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiLwn5uRIFtWT0xBVElMSVRZIEJMT0NLXSBCVEMgMUggUmFuZ2Uge3JuZyoxMDA6LjJmfSUgPiAyJS4gU3RvcHBpbmcgU2Nhbi4iKQogICAgICAgICAgICAgICAgICAgICAgICAgIyBDbGVhciBjYW5kaWRhdGVzIHRvIHNraXAKICAgICAgICAgICAgICAgICAgICAgICAgIHRvcF9nYWluZXJzID0gW10KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiW0JUQyBDSEVDSyBGQUlMXSB7ZX0iKQoKICAgICAgICAgICAgIyBDb250ZXh0IE9iamVjdCBmb3IgcGFzc2luZyBCVEMgZGF0YQogICAgICAgICAgICBzY2FuX2NvbnRleHQgPSB7ImJ0Y19wY3QiOiBidGNfcGN0fQoKICAgICAgICAgICAgIyBXZSBmZXRjaCBhbGwgY2FuZGlkYXRlcyBpbiBwYXJhbGxlbAogICAgICAgICAgICBzbWNfdGFza3MgPSBbc2Nhbl9zbWNfdGFyZ2V0KHMsIGV4X2xpdmUsIHNjYW5fY29udGV4dCkgZm9yIHMgaW4gdG9wX2dhaW5lcnNdCiAgICAgICAgICAgIHNtY19yZXN1bHRzID0gYXdhaXQgYXN5bmNpby5nYXRoZXIoKnNtY190YXNrcykKICAgICAgICAgICAgCiAgICAgICAgICAgIG5ld19zbWNfY2FjaGUgPSBbXQogICAgICAgICAgICBidWxsaXNoX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgIyBQcm9jZXNzIFNNQyBSZXN1bHRzIChTZXF1ZW50aWFsIEV4ZWN1dGlvbiBmb3Igc2FmZXR5KQogICAgICAgICAgICBmb3IgcmVzIGluIHNtY19yZXN1bHRzOgogICAgICAgICAgICAgICAgc3ltLCBkYXRhLCBkaWFnLCBzaWcsIGlzX2J1bGxpc2ggPSByZXMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgaXNfYnVsbGlzaDogYnVsbGlzaF9jb3VudCArPSAxCiAgICAgICAgICAgICAgICBpZiBkYXRhOiAKICAgICAgICAgICAgICAgICAgICBuZXdfc21jX2NhY2hlLmV4dGVuZChkYXRhKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBkaWFnOgogICAgICAgICAgICAgICAgICAgIGRpYWdbJ3RpbWUnXSA9IGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpLmlzb2Zvcm1hdCgpCiAgICAgICAgICAgICAgICAgICAgbmVhcl9oaXRzLmluc2VydCgwLCBkaWFnKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBzaWc6CiAgICAgICAgICAgICAgICAgICAgIyBFeGVjdXRlIFRyYWRlIChTZXF1ZW50aWFsLCBTYWZlKQogICAgICAgICAgICAgICAgICAgIHNsX2FicyA9IGRpYWcuZ2V0KCdzbCcpCiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlcl90eXBlID0gZGlhZy5nZXQoJ3RyaWdnZXInLCAnU01DJykKICAgICAgICAgICAgICAgICAgICBzdHJhdGVneV9uYW1lID0gZiJTTUNfe3RyaWdnZXJfdHlwZX0iCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgYnRjX211bHRpcGxpZXIgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBleGVjdXRlX2J1eShzeW0sIE5vbmUsIE5vbmUsIHN0cmF0ZWd5X25hbWUsIHNsX2Fic29sdXRlPXNsX2FicywgYnRjX211bHRpcGxpZXI9YnRjX211bHRpcGxpZXIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLwn5uRIFtSRUdJTUUgQkxPQ0tdIHtzeW19OiBTaWduYWwgaWdub3JlZCBkdWUgdG8gQmVhcmlzaCBCVEMgUmVnaW1lIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBbVklTSUJJTElUWV0gTG9nIFJlamVjdGlvbnMgKFVzZXIgQXNzdXJhbmNlKQogICAgICAgICAgICAgICAgZWxpZiBkaWFnIGFuZCAicmVhc29uIiBpbiBkaWFnOgogICAgICAgICAgICAgICAgICAgICAjIE9ubHkgbG9nIGludGVyZXN0aW5nIHJlamVjdGlvbnMgKG5vdCBqdXN0ICJUcmVuZCBEb3duIiB3aGljaCBpcyBjb21tb24/IAogICAgICAgICAgICAgICAgICAgICAjIE5vLCBsb2cgYWxsIGZvciBub3cgdG8gcHJvdmUgaXQgd29ya3MpLgogICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfm6HvuI8gW0ZJTFRFUiBCTE9DS10ge3N5bX06IHtkaWFnWydyZWFzb24nXX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgW0ZJWF0gQWxzbyBTY2FuIEFjdGl2ZSBQb3NpdGlvbnMgZm9yIERhc2hib2FyZCBWaXN1YWxpemF0aW9uCiAgICAgICAgICAgIGFjdGl2ZV9zeW1ib2xzID0gW3RbJ3N5bWJvbCddIGZvciB0IGluIG9wZW5fdHJhZGVzXQogICAgICAgICAgICBtaXNzaW5nX2FjdGl2ZSA9IFtzIGZvciBzIGluIGFjdGl2ZV9zeW1ib2xzIGlmIHMgbm90IGluIHRvcF9nYWluZXJzXQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbWlzc2luZ19hY3RpdmU6CiAgICAgICAgICAgICAgICBhY3RpdmVfcmVzID0gYXdhaXQgYXN5bmNpby5nYXRoZXIoKltzY2FuX3NtY190YXJnZXQocywgZXhfbGl2ZSwgYWN0aXZlX3N0cmF0cykgZm9yIHMgaW4gbWlzc2luZ19hY3RpdmVdKQogICAgICAgICAgICAgICAgZm9yIHJlcyBpbiBhY3RpdmVfcmVzOgogICAgICAgICAgICAgICAgICAgIF8sIGRhdGEsIF8sIF8sIF8gPSByZXMKICAgICAgICAgICAgICAgICAgICBpZiBkYXRhOiBuZXdfc21jX2NhY2hlLmV4dGVuZChkYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgR2xvYmFsIENhY2hlCiAgICAgICAgICAgIHNtY19zY2FubmVyX2NhY2hlID0gbmV3X3NtY19jYWNoZVs6MjBdCiAgICAgICAgICAgIHdoaWxlIGxlbihuZWFyX2hpdHMpID4gMjA6IG5lYXJfaGl0cy5wb3AoKQoKICAgICAgICAgICAgIyBVSSBTWU5DCiAgICAgICAgICAgIGlmIGxlbih0b3BfZ2FpbmVycykgPiAwOgogICAgICAgICAgICAgICAgcmF3ID0gaW50KChidWxsaXNoX2NvdW50IC8gbGVuKHRvcF9nYWluZXJzKSkgKiAxMDApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIGJ0Y19yZWdpbWUgPT0gImJlYXJpc2giOgogICAgICAgICAgICAgICAgICAgIG1hcmtldF90cmVuZF9zY29yZSA9IG1pbihyYXcsIDIwKSAKICAgICAgICAgICAgICAgICAgICBtYXJrZXRfdHJlbmRfbGFiZWwgPSAiQmVhcmlzaCIKICAgICAgICAgICAgICAgIGVsaWYgYnRjX3JlZ2ltZSA9PSAibmV1dHJhbCI6CiAgICAgICAgICAgICAgICAgICAgbWFya2V0X3RyZW5kX3Njb3JlID0gbWluKHJhdywgNTApIAogICAgICAgICAgICAgICAgICAgIG1hcmtldF90cmVuZF9sYWJlbCA9ICJOZXV0cmFsIgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBtYXJrZXRfdHJlbmRfc2NvcmUgPSByYXcKICAgICAgICAgICAgICAgICAgICBtYXJrZXRfdHJlbmRfbGFiZWwgPSAiQnVsbGlzaCIKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+TiCBbTUFSS0VUIFRSRU5EXSBTY29yZToge21hcmtldF90cmVuZF9zY29yZX0vMTAwICh7bWFya2V0X3RyZW5kX2xhYmVsfSkgfCBSZWdpbWU6IHtidGNfcmVnaW1lfSAoe2J0Y19tdWx0aXBsaWVyfXgpIikKCiAgICAgICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAgICAgICMgRU5EIE9GIExPT1AKICAgICAgICAgICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICAgICAgZHVyYXRpb24gPSAoZGF0ZXRpbWUubm93KCkgLSBzdGFydF90cykudG90YWxfc2Vjb25kcygpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiW1NDQU5ORVJdIEN5Y2xlIGNvbXBsZXRlIGluIHtkdXJhdGlvbjouMmZ9cy4iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oIlN0cmF0ZWd5IGxvb3AgY3Jhc2hlZCIpCiAgICAgICAgCiAgICAgICAgYXdhaXQgYXN5bmNpby5zbGVlcCg2MCkKCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIEZBU1RBUEkgRU5EUE9JTlRTCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCkBhcHAuZ2V0KCIvc3RhdHMiLCBkZXBlbmRlbmNpZXM9W0RlcGVuZHMoZ2V0X2N1cnJlbnRfdXNlcildKQphc3luYyBkZWYgc3RhdHMoKToKICAgIGVxdWl0eSwgbG9ja2VkLCBmcmVlLCBhcGlfc3RhdHVzLCBhcGlfZXJyb3IgPSBhd2FpdCBnZXRfZXF1aXR5X2xvY2tlZF9mcmVlKCkKICAgIHN0YXRlID0gYXdhaXQgZ2V0X2FwcF9zdGF0ZSgpCiAgICAKICAgIGFsbF90cmFkZXMgPSBhd2FpdCBkYi5nZXRfYWxsX3RyYWRlc19kZXNjKGxpbWl0PTUwMCkKICAgIGNsb3NlZCA9IFt0IGZvciB0IGluIGFsbF90cmFkZXMgaWYgdFsnc3RhdHVzJ10gPT0gJ2Nsb3NlZCddCiAgICB3aW5zID0gW3QgZm9yIHQgaW4gY2xvc2VkIGlmIHRbJ3BubCddID4gMF0KICAgIHRvdGFsX3JlYWxpemVkX3BubCA9IHN1bSh0WydwbmwnXSBmb3IgdCBpbiBjbG9zZWQpCiAgICAKICAgICMgW05FV10gVW5yZWFsaXplZCBQbkwgZnJvbSBvcGVuIHRyYWRlcwogICAgb3Blbl90cmFkZXMgPSBhd2FpdCBkYi5nZXRfb3Blbl90cmFkZXMoKQogICAgdG90YWxfdW5yZWFsaXplZF9wbmwgPSBzdW0oKHQuZ2V0KCd1bnJlYWxpemVkX3BubCcpIG9yIDAuMCkgZm9yIHQgaW4gb3Blbl90cmFkZXMpCiAgICAKICAgIHJldHVybiB7CiAgICAgICAgImJhbGFuY2UiOiBlcXVpdHksCiAgICAgICAgImxvY2tlZCI6IGxvY2tlZCwKICAgICAgICAiZnJlZSI6IGZyZWUsCiAgICAgICAgIm1vZGUiOiAiYXV0byIgaWYgc3RhdGUuZ2V0KCJhdXRvX3RyYWRpbmciKSBlbHNlICJtYW51YWwiLAogICAgICAgICJ0b3RhbF9wbmwiOiBzYWZlKHRvdGFsX3JlYWxpemVkX3BubCArIHRvdGFsX3VucmVhbGl6ZWRfcG5sKSwKICAgICAgICAicmVhbGl6ZWRfcG5sIjogc2FmZSh0b3RhbF9yZWFsaXplZF9wbmwpLAogICAgICAgICJ1bnJlYWxpemVkX3BubCI6IHNhZmUodG90YWxfdW5yZWFsaXplZF9wbmwpLAogICAgICAgICJ3aW5fcmF0ZSI6IHNhZmUoKGxlbih3aW5zKS9sZW4oY2xvc2VkKSoxMDApIGlmIGNsb3NlZCBlbHNlIDApLAoKICAgICAgICAidG90YWxfdHJhZGVzIjogbGVuKGNsb3NlZCksCiAgICAgICAgImFwaV9zdGF0dXMiOiBhcGlfc3RhdHVzLAogICAgICAgICJhcGlfZXJyb3IiOiBhcGlfZXJyb3IsCiAgICAgICAgCiAgICAgICAgIyBbTUFSS0VUIElOVEVMTElHRU5DRV0KICAgICAgICAibWFya2V0X3RyZW5kX3Njb3JlIjogbWFya2V0X3RyZW5kX3Njb3JlLAogICAgICAgICJtYXJrZXRfdHJlbmRfbGFiZWwiOiBtYXJrZXRfdHJlbmRfbGFiZWwsCiAgICAgICAgCiAgICAgICAgIyBbQ0lSQ1VJVCBCUkVBS0VSXSAtIERJU0FCTEVECiAgICAgICAgImNpcmN1aXRfYnJlYWtlcl90cmlnZ2VyZWQiOiBGYWxzZSwgIyBzdGF0ZS5nZXQoImRhaWx5X2xvc3Nlc19jb3VudCIsIDApID49IE1BWF9EQUlMWV9MT1NJTkdfVFJBREVTLAogICAgICAgICJyZXNldF90aW1lX3RzIjogaW50KGRhdGV0aW1lLm5vdygpLnJlcGxhY2UoaG91cj0yMywgbWludXRlPTU5LCBzZWNvbmQ9NTksIG1pY3Jvc2Vjb25kPTApLnRpbWVzdGFtcCgpICogMTAwMCkKICAgIH0KCkBhcHAuZ2V0KCIvdHJhZGVzIiwgZGVwZW5kZW5jaWVzPVtEZXBlbmRzKGdldF9jdXJyZW50X3VzZXIpXSkKYXN5bmMgZGVmIGdldF90cmFkZXMoKToKICAgIHJldHVybiBhd2FpdCBkYi5nZXRfYWxsX3RyYWRlc19kZXNjKCkKCkBhcHAuZ2V0KCIvcG9zaXRpb25zIiwgZGVwZW5kZW5jaWVzPVtEZXBlbmRzKGdldF9jdXJyZW50X3VzZXIpXSkKYXN5bmMgZGVmIGdldF9wb3NpdGlvbnMoKToKICAgICMgW09QVElNSVpBVElPTl0gUmVhZCBmcm9tIERCIGRpcmVjdGx5LiBCYWNrZ3JvdW5kIHdvcmtlciBoYW5kbGVzIHN5bmMuCiAgICByZXR1cm4gYXdhaXQgZGIuZ2V0X29wZW5fdHJhZGVzKCkKCkBhcHAuZ2V0KCIvc2lnbmFscyIsIGRlcGVuZGVuY2llcz1bRGVwZW5kcyhnZXRfY3VycmVudF91c2VyKV0pCmFzeW5jIGRlZiBnZXRfc2lnbmFscygpOgogICAgcmV0dXJuIG5lYXJfaGl0cwoKQGFwcC5nZXQoIi9oaXN0b3J5IiwgZGVwZW5kZW5jaWVzPVtEZXBlbmRzKGdldF9jdXJyZW50X3VzZXIpXSkKYXN5bmMgZGVmIGdldF9oaXN0b3J5KHN5bWJvbDogc3RyLCBpbnRlcnZhbDogc3RyID0gIjE1bSIpOgogICAgIiIiRmV0Y2ggcHJpbWl0aXZlIE9ITENWIGhpc3RvcnkgZm9yIGN1c3RvbSBjaGFydHMiIiIKICAgIHRyeToKICAgICAgICBpZiBzeW1ib2wubG93ZXIoKSA9PSAiYnRjL3VzZHQiOgogICAgICAgICAgICAgb2hsY3YgPSBhd2FpdCBleF9saXZlLmZldGNoX29obGN2KHN5bWJvbCwgaW50ZXJ2YWwsIGxpbWl0PTIwMCkKICAgICAgICBlbHNlOgogICAgICAgICAgICAgIyBVc2UgdGhlIHNhbWUgZXhjaGFuZ2UgaW5zdGFuY2UgYXMgc3RyYXRlZ3kKICAgICAgICAgICAgIG9obGN2ID0gYXdhaXQgZXhfbGl2ZS5mZXRjaF9vaGxjdihzeW1ib2wsIGludGVydmFsLCBsaW1pdD0yMDApCiAgICAgICAgICAgICAKCiAgICAgICAgIyBDb252ZXJ0IHRvIFBhbmRhcyBmb3IgSW5kaWNhdG9ycwogICAgICAgIGRmX2hpc3QgPSBwZC5EYXRhRnJhbWUob2hsY3YsIGNvbHVtbnM9Wyd0aW1lJywgJ29wZW4nLCAnaGlnaCcsICdsb3cnLCAnY2xvc2UnLCAndm9sdW1lJ10pCiAgICAgICAgZGZfaGlzdFsnZW1hNSddID0gZGZfaGlzdFsnY2xvc2UnXS5ld20oc3Bhbj01LCBhZGp1c3Q9RmFsc2UpLm1lYW4oKSAjIFtORVddIEVNQSA1CiAgICAgICAgZGZfaGlzdFsnZW1hNTAnXSA9IGRmX2hpc3RbJ2Nsb3NlJ10uZXdtKHNwYW49NTAsIGFkanVzdD1GYWxzZSkubWVhbigpCgogICAgICAgICMgW05FV10gU2ltcGxlIFJTSSBDYWxjCiAgICAgICAgZGVsdGEgPSBkZl9oaXN0WydjbG9zZSddLmRpZmYoKQogICAgICAgIGdhaW4gPSAoZGVsdGEud2hlcmUoZGVsdGEgPiAwLCAwKSkucm9sbGluZyh3aW5kb3c9MTQpLm1lYW4oKQogICAgICAgIGxvc3MgPSAoLWRlbHRhLndoZXJlKGRlbHRhIDwgMCwgMCkpLnJvbGxpbmcod2luZG93PTE0KS5tZWFuKCkKICAgICAgICBycyA9IGdhaW4gLyAobG9zcy5yZXBsYWNlKDAsIDAuMDAwMSkpCiAgICAgICAgZGZfaGlzdFsncnNpJ10gPSAxMDAgLSAoMTAwIC8gKDEgKyBycykpCgogICAgICAgIGNhbmRsZXMgPSBbXQogICAgICAgIGVtYTUgPSBbXSAjIFtORVddCiAgICAgICAgZW1hNTAgPSBbXQogICAgICAgIHJzaSA9IFtdCgogICAgICAgIGZvciBpLCByb3cgaW4gZGZfaGlzdC5pdGVycm93cygpOgogICAgICAgICAgICB0X3NlYyA9IGludChyb3dbJ3RpbWUnXSAvIDEwMDApCiAgICAgICAgICAgIGNhbmRsZXMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICJ0aW1lIjogdF9zZWMsIAogICAgICAgICAgICAgICAgIm9wZW4iOiByb3dbJ29wZW4nXSwKICAgICAgICAgICAgICAgICJoaWdoIjogcm93WydoaWdoJ10sCiAgICAgICAgICAgICAgICAibG93Ijogcm93Wydsb3cnXSwKICAgICAgICAgICAgICAgICJjbG9zZSI6IHJvd1snY2xvc2UnXQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHBkLmlzbmEocm93WydlbWE1J10pOgogICAgICAgICAgICAgICAgZW1hNS5hcHBlbmQoeyJ0aW1lIjogdF9zZWMsICJ2YWx1ZSI6IHJvd1snZW1hNSddfSkKICAgICAgICAgICAgaWYgbm90IHBkLmlzbmEocm93WydlbWE1MCddKToKICAgICAgICAgICAgICAgIGVtYTUwLmFwcGVuZCh7InRpbWUiOiB0X3NlYywgInZhbHVlIjogcm93WydlbWE1MCddfSkKICAgICAgICAgICAgaWYgbm90IHBkLmlzbmEocm93Wydyc2knXSk6CiAgICAgICAgICAgICAgICByc2kuYXBwZW5kKHsidGltZSI6IHRfc2VjLCAidmFsdWUiOiByb3dbJ3JzaSddfSkKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgImNhbmRsZXMiOiBjYW5kbGVzLAogICAgICAgICAgICAiZW1hMjAiOiBlbWE1LCAjIEhhY2s6IFNlbmQgRU1BIDUgaW4gdGhlICJlbWEyMCIgc2xvdCBmb3Igbm93IHRvIGtlZXAgZnJvbnRlbmQgd29ya2luZwogICAgICAgICAgICAiZW1hNSI6IGVtYTUsICAjIFNlbmQgY29ycmVjdCBrZXkgdG9vIGZvciBmdXR1cmUgdXBkYXRlCiAgICAgICAgICAgICJlbWE1MCI6IGVtYTUwLAogICAgICAgICAgICAicnNpIjogcnNpCiAgICAgICAgfQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ2dlci5lcnJvcihmIkhpc3RvcnkgZmV0Y2ggZXJyb3I6IHtlfSIpCiAgICAgICAgcmV0dXJuIHsiY2FuZGxlcyI6IFtdLCAiZW1hMjAiOiBbXSwgImVtYTUwIjogW10sICJyc2kiOiBbXX0KCkBhcHAuZ2V0KCIvc21jLXNjYW5uZXIiLCBkZXBlbmRlbmNpZXM9W0RlcGVuZHMoZ2V0X2N1cnJlbnRfdXNlcildKQphc3luYyBkZWYgZ2V0X3NtY19zY2FubmVyKCk6CiAgICByZXR1cm4gc21jX3NjYW5uZXJfY2FjaGUKCkBhcHAucG9zdCgiL3BhcGVyLXNlbGwiLCBkZXBlbmRlbmNpZXM9W0RlcGVuZHMoZ2V0X2N1cnJlbnRfYWRtaW4pXSkKYXN5bmMgZGVmIHBhcGVyX3NlbGwodHJhZGVfaWQ6IHN0ciA9IFF1ZXJ5KC4uLiksIHNlbGxfcGN0OiBmbG9hdCA9IFF1ZXJ5KDEwMC4wKSk6CiAgICBhd2FpdCBleGVjdXRlX3NlbGwodHJhZGVfaWQsIHNlbGxfcGN0LCByZWFzb249Im1hbnVhbF93ZWIiKQogICAgcmV0dXJuIHsic3RhdHVzIjogIm9rIn0KCkBhcHAucG9zdCgiL3VwZGF0ZS1zbC10cCIsIGRlcGVuZGVuY2llcz1bRGVwZW5kcyhnZXRfY3VycmVudF9hZG1pbildKQphc3luYyBkZWYgdXBkYXRlX3NsX3RwKHRyYWRlX2lkOiBzdHIgPSBRdWVyeSguLi4pLCBzbDogZmxvYXQgPSBRdWVyeSguLi4pLCB0cDogZmxvYXQgPSBRdWVyeSguLi4pKToKICAgIGF3YWl0IGRiLnVwZGF0ZV90cmFkZSh0cmFkZV9pZCwgeyJzbCI6IHNsLCAidHAiOiB0cH0pCiAgICByZXR1cm4geyJzdGF0dXMiOiAib2sifQoKQGFwcC5wb3N0KCIvYWRtaW4va2lsbCIsIGRlcGVuZGVuY2llcz1bRGVwZW5kcyhnZXRfY3VycmVudF9hZG1pbildKQphc3luYyBkZWYga2lsbCgpOgogICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgia2lsbF9zd2l0Y2giLCBUcnVlKQogICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgiYXV0b190cmFkaW5nIiwgRmFsc2UpCiAgICByZXR1cm4geyJzdGF0dXMiOiAia2lsbGVkIn0KCkBhcHAucG9zdCgiL2FkbWluL3Jlc3VtZSIsIGRlcGVuZGVuY2llcz1bRGVwZW5kcyhnZXRfY3VycmVudF9hZG1pbildKQphc3luYyBkZWYgcmVzdW1lKCk6CiAgICBhd2FpdCBkYi5zZXRfc3RhdGVfa2V5KCJraWxsX3N3aXRjaCIsIEZhbHNlKQogICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgiYXV0b190cmFkaW5nIiwgVHJ1ZSkKICAgIHJldHVybiB7InN0YXR1cyI6ICJyZXN1bWVkIn0KCkBhcHAuZ2V0KCIvYWRtaW4vdHJhZGUtdXNkIiwgZGVwZW5kZW5jaWVzPVtEZXBlbmRzKGdldF9jdXJyZW50X2FkbWluKV0pCmFzeW5jIGRlZiBnZXRfdHJhZGVfdXNkKCk6CiAgICBzdGF0ZSA9IGF3YWl0IGdldF9hcHBfc3RhdGUoKQogICAgcmV0dXJuIHsidHJhZGVfdXNkIjogc3RhdGUuZ2V0KCJ0cmFkZV91c2QiLCAxMC4wKX0KCkBhcHAucG9zdCgiL2FkbWluL3NldC10cmFkZS11c2QiLCBkZXBlbmRlbmNpZXM9W0RlcGVuZHMoZ2V0X2N1cnJlbnRfYWRtaW4pXSkKYXN5bmMgZGVmIHNldF90cmFkZV91c2QoYW1vdW50OiBmbG9hdCA9IFF1ZXJ5KC4uLiwgZ3Q9MCkpOgogICAgYXdhaXQgZGIuc2V0X3N0YXRlX2tleSgidHJhZGVfdXNkIiwgYW1vdW50KQogICAgcmV0dXJuIHsic3RhdHVzIjogInVwZGF0ZWQiLCAiYW1vdW50IjogYW1vdW50fQoKIyBbRkVBVFVSRV0gRHluYW1pYyBSaXNrIEVuZHBvaW50cwpAYXBwLmdldCgiL3Jpc2tfcGN0IiwgZGVwZW5kZW5jaWVzPVtEZXBlbmRzKGdldF9jdXJyZW50X2FkbWluKV0pCmFzeW5jIGRlZiBnZXRfcmlza19wY3QoKToKICAgIHN0YXRlID0gYXdhaXQgZ2V0X2FwcF9zdGF0ZSgpCiAgICByZXR1cm4geyJyaXNrX3BjdCI6IGZsb2F0KHN0YXRlLmdldCgicmlza19wY3QiLCAwLjAyKSl9CgpAYXBwLnBvc3QoIi9yaXNrX3BjdCIsIGRlcGVuZGVuY2llcz1bRGVwZW5kcyhnZXRfY3VycmVudF9hZG1pbildKQphc3luYyBkZWYgc2V0X3Jpc2tfcGN0KHBjdDogZmxvYXQgPSBRdWVyeSguLi4sIGd0PTAsIGxlPTEuMCkpOgogICAgIyBwY3Qgc2hvdWxkIGJlIGluIHJhdGlvIGZvcm1hdCAoZS5nLiAwLjAxIGZvciAxJSkKICAgIGF3YWl0IGRiLnNldF9zdGF0ZV9rZXkoInJpc2tfcGN0IiwgcGN0KQogICAgcmV0dXJuIHsic3RhdHVzIjogInVwZGF0ZWQiLCAicmlza19wY3QiOiBwY3R9Cg=="
DEST = "/opt/gitco/alpha-trader-bot/main.py"

print(f"Restoring {DEST}...")
with open(DEST, "wb") as f:
    f.write(base64.b64decode(B64_DATA))
print(" Restore complete.")
